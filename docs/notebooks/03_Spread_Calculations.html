
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Equity Spot-Futures Arbitrage: Implied Forward Rate Computation &#8212; Equity Spot Futures Arbitrage Replication</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=b9472d72"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/03_Spread_Calculations';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Futures Data Processing Walkthrough" href="02_Futures_Data_Processing.html" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>   
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Equity Spot Futures Arbitrage Replication - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Equity Spot Futures Arbitrage Replication - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    HW5: SPX Hedging with Options
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Notebooks 📖</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01_OIS_Data_Processing.html">OIS Rate Data Processing Walkthrough</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_Futures_Data_Processing.html">Futures Data Processing Walkthrough</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Equity Spot-Futures Arbitrage: Implied Forward Rate Computation</a></li>


</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/jmbejara/blank_project" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/jmbejara/blank_project/issues/new?title=Issue%20on%20page%20%2Fnotebooks/03_Spread_Calculations.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/03_Spread_Calculations.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Equity Spot-Futures Arbitrage: Implied Forward Rate Computation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Equity Spot-Futures Arbitrage: Implied Forward Rate Computation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#theoretical-background">Theoretical Background</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-the-functions-visual-understanding-of-implied-forward-rate-calculation">Exploring the Functions: Visual Understanding of Implied Forward Rate Calculation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-daily-dividends">Understanding Daily Dividends</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-barndorff-nielsen-outlier-filter">Understanding Barndorff-Nielsen Outlier Filter</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-forward-rate-calculation-process">Understanding the Forward Rate Calculation Process</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preparation-merging">1. Data Preparation &amp; Merging</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dividend-sums">2. Dividend Sums</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dividend-compounding">3. Dividend Compounding</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implied-forward-rate">4. Implied Forward Rate</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ois-implied-forward-rate">5. OIS-Implied Forward Rate</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spread-calculation">6. Spread Calculation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-filtering">7. Outlier Filtering</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#theoretical-understanding-of-implied-forward-rate-calculation">Theoretical Understanding of Implied Forward Rate Calculation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">1. Understanding Daily Dividends</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#barndorff-nielsen-outlier-filter">2. Barndorff-Nielsen Outlier Filter</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#forward-rate-calculation-process">3. Forward Rate Calculation Process</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-index-analysis">4. Cross-Index Analysis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#theoretical-framework">5. Theoretical Framework</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                   <section class="tex2jax_ignore mathjax_ignore" id="equity-spot-futures-arbitrage-implied-forward-rate-computation">
<h1>Equity Spot-Futures Arbitrage: Implied Forward Rate Computation<a class="headerlink" href="#equity-spot-futures-arbitrage-implied-forward-rate-computation" title="Link to this heading">#</a></h1>
<p>This notebook demonstrates how to compute implied forward rates from equity index futures, mirroring the approach of Hazelkorn et al. (2021). Our goal is to construct:</p>
<div class="math notranslate nohighlight">
\[
\text{ESF}_t \;=\; f_{t,\tau_1,\tau_2} \;-\; \text{OIS3M}_t
\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[
f_{t,\tau_1,\tau_2} \;=\; \frac{F_{t,\tau_2} + \mathbb{E}_t^Q[D_{t,\tau_2}]}{F_{t,\tau_1} + \mathbb{E}_t^Q[D_{t,\tau_1}]} - 1,
\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[
F_{t,\tau} \;=\; S_t\bigl(1 + r_{t,\tau}^f\bigr) \;-\; \mathbb{E}_t^Q[D_{t,\tau}].
\]</div>
<p>The difference between the <strong>futures-implied forward rate</strong> and the <strong>3-month OIS rate</strong> can reveal potential funding frictions or other market constraints that prevent perfect spot-futures arbitrage in equity markets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">calendar</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">&#39;whitegrid&#39;</span><span class="p">)</span>

<span class="c1"># Add the src directory to the path to import our settings</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;./src&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Successfully imported config from settings module&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to import config. Using local fallback.&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">config</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="n">config_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;DATA_DIR&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./_data&quot;</span><span class="p">),</span>
            <span class="s2">&quot;TEMP_DIR&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./_data/temp&quot;</span><span class="p">),</span>
            <span class="s2">&quot;INPUT_DIR&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./_data/input&quot;</span><span class="p">),</span>
            <span class="s2">&quot;PROCESSED_DIR&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./_data/processed&quot;</span><span class="p">),</span>
            <span class="s2">&quot;MANUAL_DATA_DIR&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./data_manual&quot;</span><span class="p">),</span>
            <span class="s2">&quot;OUTPUT_DIR&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./_output&quot;</span><span class="p">),</span>
            <span class="s2">&quot;START_DATE&quot;</span><span class="p">:</span> <span class="s2">&quot;2010-01-01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;END_DATE&quot;</span><span class="p">:</span> <span class="s2">&quot;2025-01-01&quot;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">))</span>

<span class="c1"># Basic paths</span>
<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s2">&quot;DATA_DIR&quot;</span><span class="p">)</span>
<span class="n">TEMP_DIR</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s2">&quot;TEMP_DIR&quot;</span><span class="p">)</span>
<span class="n">INPUT_DIR</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s2">&quot;INPUT_DIR&quot;</span><span class="p">)</span>
<span class="n">PROCESSED_DIR</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s2">&quot;PROCESSED_DIR&quot;</span><span class="p">)</span>
<span class="n">DATA_MANUAL</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s2">&quot;MANUAL_DATA_DIR&quot;</span><span class="p">)</span>
<span class="n">OUTPUT_DIR</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s2">&quot;OUTPUT_DIR&quot;</span><span class="p">)</span>

<span class="n">START_DATE</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;START_DATE&quot;</span><span class="p">))</span>
<span class="n">END_DATE</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;END_DATE&quot;</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DATA_DIR = </span><span class="si">{</span><span class="n">DATA_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PROCESSED_DIR = </span><span class="si">{</span><span class="n">PROCESSED_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;START_DATE = </span><span class="si">{</span><span class="n">START_DATE</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">, END_DATE = </span><span class="si">{</span><span class="n">END_DATE</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">INDEX_CODES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SPX&quot;</span><span class="p">,</span> <span class="s2">&quot;NDX&quot;</span><span class="p">,</span> <span class="s2">&quot;INDU&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Successfully imported config from settings module
DATA_DIR = C:\Users\Andik\OneDrive\Desktop\Chicago\Full_stack_QF\Equity_Spot_futures_arb\_data
PROCESSED_DIR = C:\Users\Andik\OneDrive\Desktop\Chicago\Full_stack_QF\Equity_Spot_futures_arb\_data\processed
START_DATE = 2010-01-01, END_DATE = 2024-12-31
</pre></div>
</div>
</div>
</div>
<section id="theoretical-background">
<h2>Theoretical Background<a class="headerlink" href="#theoretical-background" title="Link to this heading">#</a></h2>
<p>In classical spot-futures parity for an equity index (S_t) that pays dividends from (t) to (t + \tau), the no-arbitrage futures price is:</p>
<div class="math notranslate nohighlight">
\[
F_{t,\tau} \;=\; S_t\,(1 + r_{t,\tau}^f) \;-\; \mathbb{E}_t^Q[D_{t,\tau}].
\]</div>
<p>However, a direct spot vs. futures comparison can be noisy if they close at different times (e.g., 4:00 pm vs. 4:15 pm). Instead, we look at two futures contracts (maturing at (\tau_1) and (\tau_2)):</p>
<div class="math notranslate nohighlight">
\[
1 + f_{t,\tau_1,\tau_2}
\;=\;
\frac{F_{t,\tau_2} + \mathbb{E}_t^Q[D_{t,\tau_2}]}{F_{t,\tau_1} + \mathbb{E}_t^Q[D_{t,\tau_1}]},
\]</div>
<p>to isolate the <strong>implied forward rate</strong> (f_{t,\tau_1,\tau_2}). We then define the <strong>Equity Spot-Futures Arbitrage Spread</strong> as:</p>
<div class="math notranslate nohighlight">
\[
\text{ESF}_t \;=\; f_{t,\tau_1,\tau_2} \;-\; \text{OIS3M}_t.
\]</div>
<p>A positive (\text{ESF}_t) indicates the implied equity forward rate is higher than the OIS benchmark, potentially signaling a funding-cost wedge or other limits to arbitrage.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">build_daily_dividends</span><span class="p">(</span><span class="n">index_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load daily dividends for the given index code from bloomberg_historical_data.parquet.</span>
<span class="sd">    Return columns: [Date, Daily_Div].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] Building daily dividend table&quot;</span><span class="p">)</span>

    <span class="n">input_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">INPUT_DIR</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;bloomberg_historical_data.parquet&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">input_file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Primary input file not found, switching to cached data&quot;</span><span class="p">)</span>
        <span class="n">input_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">DATA_MANUAL</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;bloomberg_historical_data.parquet&quot;</span>

    <span class="n">raw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>
    <span class="n">div_col</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2"> Index&quot;</span><span class="p">,</span> <span class="s2">&quot;INDX_GROSS_DAILY_DIV&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">div_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">raw_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing daily dividend column </span><span class="si">{</span><span class="n">div_col</span><span class="si">}</span><span class="s2"> for index=</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">div_df</span> <span class="o">=</span> <span class="n">raw_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">div_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s2">&quot;Daily_Div&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">div_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;Date&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
    <span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;Daily_Div&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;Daily_Div&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Optionally drop any row that has no valid date</span>
    <span class="n">before_drop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">div_df</span><span class="p">)</span>
    <span class="n">div_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">after_drop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">div_df</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">after_drop</span> <span class="o">&lt;</span> <span class="n">before_drop</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] Dropped </span><span class="si">{</span><span class="n">before_drop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">after_drop</span><span class="si">}</span><span class="s2"> rows with invalid or missing date in daily_div.&quot;</span><span class="p">)</span>

    <span class="n">div_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">div_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] daily dividends final shape: </span><span class="si">{</span><span class="n">div_df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] Sample daily dividends:</span><span class="se">\n</span><span class="si">{</span><span class="n">div_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">div_df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">barndorff_nielsen_filter</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                             <span class="n">colname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">date_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Date&quot;</span><span class="p">,</span>
                             <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">45</span><span class="p">,</span>
                             <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Barndorff-Nielsen outlier filter on &#39;colname&#39; over ±window days.</span>
<span class="sd">    1) rolling median =&gt; ...</span>
<span class="sd">    2) abs_dev from that median</span>
<span class="sd">    3) rolling mean(abs_dev) =&gt; mad</span>
<span class="sd">    4) outlier if abs_dev/mad &gt;= threshold =&gt; set colname_filtered=NaN</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">date_col</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">rolling_median</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="n">rolling_median_shifted</span> <span class="o">=</span> <span class="n">rolling_median</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;abs_dev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">-</span> <span class="n">rolling_median_shifted</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
    <span class="n">rolling_mad</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;abs_dev&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">rolling_mad_shifted</span> <span class="o">=</span> <span class="n">rolling_mad</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;bad_price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;abs_dev&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">rolling_mad_shifted</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">threshold</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="s2">&quot;bad_price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Count how many outliers</span>
    <span class="n">outlier_count</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;bad_price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">outlier_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Barndorff-Nielsen filter: flagged </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">outlier_count</span><span class="p">)</span><span class="si">}</span><span class="s2"> outliers in </span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s2">_filtered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;bad_price&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;abs_dev&quot;</span><span class="p">,</span> <span class="s2">&quot;bad_price&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">process_index_forward_rates</span><span class="p">(</span><span class="n">index_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    1) Load near/next futures for index_code from _Calendar_spread.csv</span>
<span class="sd">    2) Merge with single OIS_3M (as-of)</span>
<span class="sd">    3) Merge daily dividends, compute Div_Sum1_Comp &amp; Div_Sum2_Comp</span>
<span class="sd">    4) Implied forward =&gt; cal_{index_code}_rf, OIS forward =&gt; ois_fwd_{index_code}, spread</span>
<span class="sd">    5) Barndorff outlier filter, then multiply spread by 100 =&gt; bps</span>
<span class="sd">    6) Return the DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] Starting forward rate computation&quot;</span><span class="p">)</span>

    <span class="n">fut_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">PROCESSED_DIR</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">_Calendar_spread.csv&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fut_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] Missing futures file: </span><span class="si">{</span><span class="n">fut_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="n">fut_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fut_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] Loaded futures shape: </span><span class="si">{</span><span class="n">fut_df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;Date&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fut_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] No &#39;Date&#39; column in </span><span class="si">{</span><span class="n">fut_file</span><span class="si">}</span><span class="s2">, aborting.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">fut_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">fut_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>

    <span class="n">before_drop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fut_df</span><span class="p">)</span>
    <span class="n">fut_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] Dropped </span><span class="si">{</span><span class="n">before_drop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">fut_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows lacking a valid Date in futures.&quot;</span><span class="p">)</span>
    <span class="n">fut_df</span><span class="p">[</span><span class="s2">&quot;Term1_SettlementDate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">fut_df</span><span class="p">[</span><span class="s2">&quot;Term1_SettlementDate&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
    <span class="n">fut_df</span><span class="p">[</span><span class="s2">&quot;Term2_SettlementDate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">fut_df</span><span class="p">[</span><span class="s2">&quot;Term2_SettlementDate&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>

    <span class="n">fut_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fut_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># === Merge single OIS_3M</span>
    <span class="n">ois_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">PROCESSED_DIR</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;cleaned_ois_rates.csv&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ois_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] Missing OIS file: </span><span class="si">{</span><span class="n">ois_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="n">ois_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ois_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;Date&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ois_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">ois_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Unnamed: 0&quot;</span><span class="p">:</span> <span class="s2">&quot;Date&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ois_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ois_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
    <span class="n">ois_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># as-of merge</span>
    <span class="n">prev_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fut_df</span><span class="p">)</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
        <span class="n">fut_df</span><span class="p">,</span> <span class="n">ois_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;backward&quot;</span>
    <span class="p">)</span>
    <span class="n">after_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] as-of merged OIS: from </span><span class="si">{</span><span class="n">prev_len</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">after_len</span><span class="si">}</span><span class="s2"> rows (should be same).&quot;</span><span class="p">)</span>

    <span class="c1"># rename OIS_3M =&gt; &#39;OIS&#39;</span>
    <span class="k">if</span> <span class="s2">&quot;OIS_3M&quot;</span> <span class="ow">in</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">merged_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;OIS_3M&quot;</span><span class="p">:</span> <span class="s2">&quot;OIS&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] &#39;OIS_3M&#39; column not found in OIS data, using default &#39;OIS_3M&#39;?&quot;</span><span class="p">)</span>

    <span class="c1"># === Load daily dividends</span>
    <span class="n">div_df</span> <span class="o">=</span> <span class="n">build_daily_dividends</span><span class="p">(</span><span class="n">index_code</span><span class="p">)</span>
    <span class="c1"># add cumsum in div_df</span>
    <span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;CumDiv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;Daily_Div&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

    <span class="c1"># merge cumsum at current date</span>
    <span class="n">prev_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
        <span class="n">merged_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">),</span>
        <span class="n">div_df</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;CumDiv&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">),</span>
        <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;backward&quot;</span>
    <span class="p">)</span>
    <span class="n">after_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] as-of merged CumDiv at current date: from </span><span class="si">{</span><span class="n">prev_len</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">after_len</span><span class="si">}</span><span class="s2"> rows.&quot;</span>
    <span class="p">)</span>
    <span class="n">merged_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;CumDiv&quot;</span><span class="p">:</span> <span class="s2">&quot;CumDiv_current&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] Sample merged rows with cumulative div:</span><span class="se">\n</span><span class="si">{</span><span class="n">merged_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># same approach for Term1 &amp; Term2</span>
    <span class="n">t1_df</span> <span class="o">=</span> <span class="n">div_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Date&quot;</span><span class="p">:</span> <span class="s2">&quot;Term1_SettlementDate&quot;</span><span class="p">,</span> <span class="s2">&quot;CumDiv&quot;</span><span class="p">:</span> <span class="s2">&quot;CumDiv_Term1&quot;</span><span class="p">})</span>
    <span class="n">prev_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
        <span class="n">merged_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Term1_SettlementDate&quot;</span><span class="p">),</span>
        <span class="n">t1_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Term1_SettlementDate&quot;</span><span class="p">),</span>
        <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Term1_SettlementDate&quot;</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;backward&quot;</span>
    <span class="p">)</span>
    <span class="n">after_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] as-of merged CumDiv for Term1: from </span><span class="si">{</span><span class="n">prev_len</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">after_len</span><span class="si">}</span><span class="s2"> rows.&quot;</span>
    <span class="p">)</span>

    <span class="n">t2_df</span> <span class="o">=</span> <span class="n">div_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Date&quot;</span><span class="p">:</span> <span class="s2">&quot;Term2_SettlementDate&quot;</span><span class="p">,</span> <span class="s2">&quot;CumDiv&quot;</span><span class="p">:</span> <span class="s2">&quot;CumDiv_Term2&quot;</span><span class="p">})</span>
    <span class="n">prev_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
        <span class="n">merged_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Term2_SettlementDate&quot;</span><span class="p">),</span>
        <span class="n">t2_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Term2_SettlementDate&quot;</span><span class="p">),</span>
        <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Term2_SettlementDate&quot;</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;backward&quot;</span>
    <span class="p">)</span>
    <span class="n">after_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] as-of merged CumDiv for Term2: from </span><span class="si">{</span><span class="n">prev_len</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">after_len</span><span class="si">}</span><span class="s2"> rows.&quot;</span>
    <span class="p">)</span>

    <span class="c1"># compute Div_Sum1 &amp; Div_Sum2</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Div_Sum1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;CumDiv_Term1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;CumDiv_current&quot;</span><span class="p">]</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Div_Sum2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;CumDiv_Term2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;CumDiv_current&quot;</span><span class="p">]</span>

    <span class="c1"># Handle missing TTM or price</span>
    <span class="c1"># If TTM is missing, can&#39;t compute rates =&gt; drop</span>
    <span class="n">before_drop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span>
    <span class="n">merged_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Term1_TTM&quot;</span><span class="p">,</span> <span class="s2">&quot;Term2_TTM&quot;</span><span class="p">,</span> <span class="s2">&quot;Term1_Futures_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Term2_Futures_Price&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] Dropped </span><span class="si">{</span><span class="n">before_drop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows missing TTM or Futures_Price.&quot;</span>
    <span class="p">)</span>

    <span class="c1"># 4) Compounding</span>
    <span class="n">ttm1</span> <span class="o">=</span> <span class="s2">&quot;Term1_TTM&quot;</span>
    <span class="n">ttm2</span> <span class="o">=</span> <span class="s2">&quot;Term2_TTM&quot;</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Div_Sum1_Comp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Div_Sum1&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="p">((</span><span class="n">merged_df</span><span class="p">[</span><span class="n">ttm1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">360.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;OIS&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span>
    <span class="p">)</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Div_Sum2_Comp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Div_Sum2&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="p">((</span><span class="n">merged_df</span><span class="p">[</span><span class="n">ttm2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">360.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;OIS&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span>
    <span class="p">)</span>

    <span class="c1"># Implied Forward</span>
    <span class="n">fp1</span> <span class="o">=</span> <span class="s2">&quot;Term1_Futures_Price&quot;</span>
    <span class="n">fp2</span> <span class="o">=</span> <span class="s2">&quot;Term2_Futures_Price&quot;</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;implied_forward_raw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">merged_df</span><span class="p">[</span><span class="n">fp2</span><span class="p">]</span> <span class="o">+</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Div_Sum2_Comp&quot;</span><span class="p">])</span> <span class="o">/</span>
        <span class="p">(</span><span class="n">merged_df</span><span class="p">[</span><span class="n">fp1</span><span class="p">]</span> <span class="o">+</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Div_Sum1_Comp&quot;</span><span class="p">])</span>
        <span class="o">-</span> <span class="mf">1.0</span>
    <span class="p">)</span>

    <span class="n">dt</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="n">ttm2</span><span class="p">]</span> <span class="o">-</span> <span class="n">merged_df</span><span class="p">[</span><span class="n">ttm1</span><span class="p">]</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cal_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">_rf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="mf">100.0</span> <span class="o">*</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;implied_forward_raw&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">360.0</span> <span class="o">/</span> <span class="n">dt</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="p">)</span>

    <span class="c1"># OIS-implied forward</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;ois_fwd_raw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;OIS&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">merged_df</span><span class="p">[</span><span class="n">ttm2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">360.0</span><span class="p">)</span> <span class="o">/</span>
        <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;OIS&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">merged_df</span><span class="p">[</span><span class="n">ttm1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">360.0</span><span class="p">)</span>
        <span class="o">-</span> <span class="mf">1.0</span>
    <span class="p">)</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ois_fwd_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;ois_fwd_raw&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">360.0</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="p">)</span>

    <span class="c1"># Spread</span>
    <span class="n">spread_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;spread_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="n">spread_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cal_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">_rf&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">merged_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ois_fwd_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    
    <span class="c1"># BN outlier filter</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">barndorff_nielsen_filter</span><span class="p">(</span><span class="n">merged_df</span><span class="p">,</span> <span class="n">spread_col</span><span class="p">,</span> <span class="n">date_col</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    
    <span class="c1"># If outlier =&gt; set cal_rf &amp; spread to NaN</span>
    <span class="n">out_mask</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spread_col</span><span class="si">}</span><span class="s2">_filtered&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
    <span class="n">outliers_count</span> <span class="o">=</span> <span class="n">out_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">outliers_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] Setting </span><span class="si">{</span><span class="n">outliers_count</span><span class="si">}</span><span class="s2"> outliers to NaN for cal_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">_rf &amp; </span><span class="si">{</span><span class="n">spread_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">merged_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">out_mask</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cal_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">_rf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">merged_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">out_mask</span><span class="p">,</span> <span class="n">spread_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># Multiply spread by 100 =&gt; bps</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="n">spread_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="n">spread_col</span><span class="p">]</span> <span class="o">*</span> <span class="mf">100.0</span>
    <span class="n">merged_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] Final forward rates shape: </span><span class="si">{</span><span class="n">merged_df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">] Sample final rows:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="o">+</span> <span class="n">merged_df</span><span class="p">[[</span><span class="sa">f</span><span class="s2">&quot;cal_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">_rf&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ois_fwd_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spread_col</span><span class="p">]]</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">merged_df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_all_indices</span><span class="p">(</span><span class="n">results</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">keep_dates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate two charts for each index&#39;s final spread_{idx} in basis points:</span>
<span class="sd">    1. From START_DATE to 2020-01-01</span>
<span class="sd">    2. From START_DATE to END_DATE (full range)</span>
<span class="sd">    </span>
<span class="sd">    By default (keep_dates=True), we reindex to the union of all dates to keep the</span>
<span class="sd">    X-axis from skipping days that are missing in some index.</span>
<span class="sd">    </span>
<span class="sd">    If you want to only show existing dates in each index&#39;s data, set keep_dates=False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define date ranges</span>
    <span class="n">pre_2020_end</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2020-01-01&#39;</span><span class="p">)</span>
    
    <span class="c1"># If keep_dates: find the union of all dates across all DataFrames</span>
    <span class="k">if</span> <span class="n">keep_dates</span><span class="p">:</span>
        <span class="n">all_dates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">all_dates</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="c1"># Build a sorted list</span>
        <span class="n">date_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_dates</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">date_index</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">colors</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;SPX&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;NDX&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;INDU&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">}</span>
    
    <span class="c1"># Create Figure 1: START_DATE to 2020-01-01</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">spread_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;spread_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># Filter to pre-2020 data</span>
            <span class="n">pre_2020_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">pre_2020_end</span><span class="p">]</span>
            
            <span class="c1"># If empty after filtering, skip</span>
            <span class="k">if</span> <span class="n">pre_2020_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">continue</span>
                
            <span class="c1"># reindex if desired</span>
            <span class="k">if</span> <span class="n">keep_dates</span> <span class="ow">and</span> <span class="n">date_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filtered_dates</span> <span class="o">=</span> <span class="n">date_index</span><span class="p">[</span><span class="n">date_index</span> <span class="o">&lt;=</span> <span class="n">pre_2020_end</span><span class="p">]</span>
                <span class="n">df_plot</span> <span class="o">=</span> <span class="n">pre_2020_df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">filtered_dates</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>  <span class="c1"># Forward fill missing values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_plot</span> <span class="o">=</span> <span class="n">pre_2020_df</span>
                
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">df_plot</span><span class="p">[</span><span class="n">spread_col</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">),</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> Spread (bps)&quot;</span>
            <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Implied Forward Spread Across Indices (Pre-2020, bps)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Spread (bps)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">YearLocator</span><span class="p">())</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">))</span>
    
    <span class="c1"># Display the first plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c1"># Create Figure 2: START_DATE to END_DATE (full range)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">spread_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;spread_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># reindex if desired</span>
            <span class="k">if</span> <span class="n">keep_dates</span> <span class="ow">and</span> <span class="n">date_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">date_index</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>  <span class="c1"># Forward fill missing values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df</span>
                
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">df_plot</span><span class="p">[</span><span class="n">spread_col</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">),</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> Spread (bps)&quot;</span>
            <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Implied Forward Spread Across Indices (Full Range, bps)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Spread (bps)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">YearLocator</span><span class="p">())</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">))</span>
    
    <span class="c1"># Display the second plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;== Starting forward rate calculations with compounding dividends, single OIS, BN outlier filter ==&quot;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">INDEX_CODES</span><span class="p">:</span>
        <span class="n">df_res</span> <span class="o">=</span> <span class="n">process_index_forward_rates</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_res</span>
    
    <span class="c1"># Create both plots</span>
    <span class="n">plot_all_indices</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">keep_dates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All computations completed successfully.&quot;</span><span class="p">)</span>

<span class="c1"># Execute the main function</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>== Starting forward rate calculations with compounding dividends, single OIS, BN outlier filter ==
[SPX] Starting forward rate computation
[SPX] Loaded futures shape: (3781, 14)
[SPX] Dropped 0 rows lacking a valid Date in futures.
[SPX] as-of merged OIS: from 3781 -&gt; 3781 rows (should be same).
[SPX] Building daily dividend table
Primary input file not found, switching to cached data
[SPX] daily dividends final shape: (3913, 2)
[SPX] Sample daily dividends:
        Date  Daily_Div
0 2010-01-01   0.000000
1 2010-01-04   0.058362
2 2010-01-05   0.001744
3 2010-01-06   0.497980
4 2010-01-07   0.061819
5 2010-01-08   0.000000
6 2010-01-11   0.000000
7 2010-01-12   0.000000
8 2010-01-13   0.113508
9 2010-01-14   0.021957
[SPX] as-of merged CumDiv at current date: from 3781 -&gt; 3781 rows.
[SPX] Sample merged rows with cumulative div:
        Date  Term1_Futures_Price  Term1_Volume  Term1_OpenInterest  \
0 2010-01-04              1128.75     1282633.0           2440458.0   
1 2010-01-05              1132.25     1368386.0           2402850.0   
2 2010-01-06              1133.00     1252015.0           2396493.0   
3 2010-01-07              1137.50     1553963.0           2406352.0   
4 2010-01-08              1141.50     1508175.0           2758348.0   
5 2010-01-11              1142.50     1444997.0           2427453.0   
6 2010-01-12              1134.00     2089364.0           2439036.0   
7 2010-01-13              1141.50     2110033.0           2475322.0   
8 2010-01-14              1145.25     1346436.0           2473392.0   
9 2010-01-15              1132.25     2031715.0           2454453.0   

  Term1_ContractSpec Term1_SettlementDate  Term1_TTM  Term2_Futures_Price  \
0             MAR 10           2010-03-19       74.0              1124.00   
1             MAR 10           2010-03-19       73.0              1127.50   
2             MAR 10           2010-03-19       72.0              1128.00   
3             MAR 10           2010-03-19       71.0              1132.50   
4             MAR 10           2010-03-19       70.0              1136.75   
5             MAR 10           2010-03-19       67.0              1137.50   
6             MAR 10           2010-03-19       66.0              1129.00   
7             MAR 10           2010-03-19       65.0              1136.75   
8             MAR 10           2010-03-19       64.0              1140.25   
9             MAR 10           2010-03-19       63.0              1127.50   

   Term2_Volume  Term2_OpenInterest Term2_ContractSpec Term2_SettlementDate  \
0        1641.0              3354.0             JUN 10           2010-06-18   
1         686.0              3432.0             JUN 10           2010-06-18   
2        1163.0              3713.0             JUN 10           2010-06-18   
3        1135.0              4154.0             JUN 10           2010-06-18   
4        1080.0             17466.0             JUN 10           2010-06-18   
5         419.0              4638.0             JUN 10           2010-06-18   
6         481.0              4765.0             JUN 10           2010-06-18   
7        1174.0              5389.0             JUN 10           2010-06-18   
8         333.0              5357.0             JUN 10           2010-06-18   
9        1432.0              5936.0             JUN 10           2010-06-18   

   Term2_TTM Index       OIS  CumDiv_current  
0      165.0   SPX  0.001620        0.058362  
1      164.0   SPX  0.001550        0.060106  
2      163.0   SPX  0.001460        0.558086  
3      162.0   SPX  0.001450        0.619905  
4      161.0   SPX  0.001430        0.619905  
5      158.0   SPX  0.001430        0.619905  
6      157.0   SPX  0.001415        0.619905  
7      156.0   SPX  0.001470        0.733413  
8      155.0   SPX  0.001430        0.755370  
9      154.0   SPX  0.001380        0.799620  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[SPX] as-of merged CumDiv for Term1: from 3781 -&gt; 3781 rows.
[SPX] as-of merged CumDiv for Term2: from 3781 -&gt; 3781 rows.
[SPX] Dropped 0 rows missing TTM or Futures_Price.
Barndorff-Nielsen filter: flagged 47 outliers in spread_SPX
[SPX] Setting 47 outliers to NaN for cal_SPX_rf &amp; spread_SPX
[SPX] Final forward rates shape: (3781, 29)
[SPX] Sample final rows:
            cal_SPX_rf  ois_fwd_SPX  spread_SPX
Date                                           
2024-12-24    3.778583     4.287412  -50.882869
2024-12-26    3.796641     4.277498  -48.085749
2024-12-27    3.741256     4.277624  -53.636841
2024-12-30    3.717731     4.275913  -55.818186
2024-12-31    3.698950     4.274017  -57.506667
[NDX] Starting forward rate computation
[NDX] Loaded futures shape: (3781, 14)
[NDX] Dropped 0 rows lacking a valid Date in futures.
[NDX] as-of merged OIS: from 3781 -&gt; 3781 rows (should be same).
[NDX] Building daily dividend table
Primary input file not found, switching to cached data
[NDX] daily dividends final shape: (3913, 2)
[NDX] Sample daily dividends:
        Date  Daily_Div
0 2010-01-01   0.000000
1 2010-01-04   0.148515
2 2010-01-05   0.000000
3 2010-01-06   0.000000
4 2010-01-07   0.000000
5 2010-01-08   0.000000
6 2010-01-11   0.000000
7 2010-01-12   0.000000
8 2010-01-13   0.000000
9 2010-01-14   0.113752
[NDX] as-of merged CumDiv at current date: from 3781 -&gt; 3781 rows.
[NDX] Sample merged rows with cumulative div:
        Date  Term1_Futures_Price  Term1_Volume  Term1_OpenInterest  \
0 2010-01-04              1886.75      204140.0            314877.0   
1 2010-01-05              1885.25      207245.0            309080.0   
2 2010-01-06              1878.50      259627.0            310532.0   
3 2010-01-07              1877.50      239907.0            317226.0   
4 2010-01-08              1890.00      267314.0            379994.0   
5 2010-01-11              1883.50      243454.0            314557.0   
6 2010-01-12              1865.50      326600.0            306114.0   
7 2010-01-13              1882.50      312998.0            331168.0   
8 2010-01-14              1888.25      204465.0            324274.0   
9 2010-01-15              1862.25      343007.0            320266.0   

  Term1_ContractSpec Term1_SettlementDate  Term1_TTM  Term2_Futures_Price  \
0             MAR 10           2010-03-19       74.0              1884.75   
1             MAR 10           2010-03-19       73.0              1883.00   
2             MAR 10           2010-03-19       72.0              1876.50   
3             MAR 10           2010-03-19       71.0              1875.00   
4             MAR 10           2010-03-19       70.0              1887.25   
5             MAR 10           2010-03-19       67.0              1880.75   
6             MAR 10           2010-03-19       66.0              1862.75   
7             MAR 10           2010-03-19       65.0              1879.75   
8             MAR 10           2010-03-19       64.0              1885.50   
9             MAR 10           2010-03-19       63.0              1859.75   

   Term2_Volume  Term2_OpenInterest Term2_ContractSpec Term2_SettlementDate  \
0          33.0               671.0             JUN 10           2010-06-18   
1          74.0               651.0             JUN 10           2010-06-18   
2          33.0               665.0             JUN 10           2010-06-18   
3          47.0               672.0             JUN 10           2010-06-18   
4        1001.0              6163.0             JUN 10           2010-06-18   
5         288.0               898.0             JUN 10           2010-06-18   
6         311.0              1077.0             JUN 10           2010-06-18   
7         710.0              1699.0             JUN 10           2010-06-18   
8         784.0              2401.0             JUN 10           2010-06-18   
9         272.0              2533.0             JUN 10           2010-06-18   

   Term2_TTM Index       OIS  CumDiv_current  
0      165.0   NDX  0.001620        0.148515  
1      164.0   NDX  0.001550        0.148515  
2      163.0   NDX  0.001460        0.148515  
3      162.0   NDX  0.001450        0.148515  
4      161.0   NDX  0.001430        0.148515  
5      158.0   NDX  0.001430        0.148515  
6      157.0   NDX  0.001415        0.148515  
7      156.0   NDX  0.001470        0.148515  
8      155.0   NDX  0.001430        0.262267  
9      154.0   NDX  0.001380        0.262267  
[NDX] as-of merged CumDiv for Term1: from 3781 -&gt; 3781 rows.
[NDX] as-of merged CumDiv for Term2: from 3781 -&gt; 3781 rows.
[NDX] Dropped 0 rows missing TTM or Futures_Price.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Barndorff-Nielsen filter: flagged 48 outliers in spread_NDX
[NDX] Setting 48 outliers to NaN for cal_NDX_rf &amp; spread_NDX
[NDX] Final forward rates shape: (3781, 29)
[NDX] Sample final rows:
            cal_NDX_rf  ois_fwd_NDX  spread_NDX
Date                                           
2024-12-24    4.341428     4.287412    5.401572
2024-12-26    4.426357     4.277498   14.885916
2024-12-27    4.384662     4.277624   10.703781
2024-12-30    4.322400     4.275913    4.648708
2024-12-31    4.323851     4.274017    4.983391
[INDU] Starting forward rate computation
[INDU] Loaded futures shape: (3780, 14)
[INDU] Dropped 0 rows lacking a valid Date in futures.
[INDU] as-of merged OIS: from 3780 -&gt; 3780 rows (should be same).
[INDU] Building daily dividend table
Primary input file not found, switching to cached data
[INDU] daily dividends final shape: (3913, 2)
[INDU] Sample daily dividends:
        Date  Daily_Div
0 2010-01-01   0.000000
1 2010-01-04   0.377875
2 2010-01-05   0.000000
3 2010-01-06   6.763957
4 2010-01-07   1.360349
5 2010-01-08   0.000000
6 2010-01-11   0.000000
7 2010-01-12   0.000000
8 2010-01-13   0.000000
9 2010-01-14   0.000000
[INDU] as-of merged CumDiv at current date: from 3780 -&gt; 3780 rows.
[INDU] Sample merged rows with cumulative div:
        Date  Term1_Futures_Price  Term1_Volume  Term1_OpenInterest  \
0 2010-01-04              10519.0       93770.0             69420.0   
1 2010-01-05              10515.0       93287.0             65749.0   
2 2010-01-06              10516.0       97172.0             63888.0   
3 2010-01-07              10545.0      112280.0             67401.0   
4 2010-01-08              10566.0       79925.0             61714.0   
5 2010-01-11              10604.0       93891.0             63318.0   
6 2010-01-12              10588.0      126885.0             62710.0   
7 2010-01-13              10628.0      113576.0             63479.0   
8 2010-01-14              10663.0       80520.0             64500.0   
9 2010-01-15              10563.0      140591.0             66826.0   

  Term1_ContractSpec Term1_SettlementDate  Term1_TTM  Term2_Futures_Price  \
0             MAR 10           2010-03-19       74.0              10459.0   
1             MAR 10           2010-03-19       73.0              10455.0   
2             MAR 10           2010-03-19       72.0              10455.0   
3             MAR 10           2010-03-19       71.0              10484.0   
4             MAR 10           2010-03-19       70.0              10505.0   
5             MAR 10           2010-03-19       67.0              10542.0   
6             MAR 10           2010-03-19       66.0              10527.0   
7             MAR 10           2010-03-19       65.0              10566.0   
8             MAR 10           2010-03-19       64.0              10601.0   
9             MAR 10           2010-03-19       63.0              10501.0   

   Term2_Volume  Term2_OpenInterest Term2_ContractSpec Term2_SettlementDate  \
0         100.0               175.0             JUN 10           2010-06-18   
1          26.0               173.0             JUN 10           2010-06-18   
2         157.0               193.0             JUN 10           2010-06-18   
3          34.0               180.0             JUN 10           2010-06-18   
4         146.0               531.0             JUN 10           2010-06-18   
5          45.0               230.0             JUN 10           2010-06-18   
6          55.0               234.0             JUN 10           2010-06-18   
7          21.0               208.0             JUN 10           2010-06-18   
8          11.0               206.0             JUN 10           2010-06-18   
9          80.0               221.0             JUN 10           2010-06-18   

   Term2_TTM Index       OIS  CumDiv_current  
0      165.0  INDU  0.001620        0.377875  
1      164.0  INDU  0.001550        0.377875  
2      163.0  INDU  0.001460        7.141832  
3      162.0  INDU  0.001450        8.502181  
4      161.0  INDU  0.001430        8.502181  
5      158.0  INDU  0.001430        8.502181  
6      157.0  INDU  0.001415        8.502181  
7      156.0  INDU  0.001470        8.502181  
8      155.0  INDU  0.001430        8.502181  
9      154.0  INDU  0.001380       11.676328  
[INDU] as-of merged CumDiv for Term1: from 3780 -&gt; 3780 rows.
[INDU] as-of merged CumDiv for Term2: from 3780 -&gt; 3780 rows.
[INDU] Dropped 0 rows missing TTM or Futures_Price.
Barndorff-Nielsen filter: flagged 43 outliers in spread_INDU
[INDU] Setting 43 outliers to NaN for cal_INDU_rf &amp; spread_INDU
[INDU] Final forward rates shape: (3780, 29)
[INDU] Sample final rows:
            cal_INDU_rf  ois_fwd_INDU  spread_INDU
Date                                              
2024-12-24     3.525951      4.287412   -76.146147
2024-12-26     3.485142      4.277498   -79.235563
2024-12-27     3.459165      4.277624   -81.845864
2024-12-30     3.446690      4.275913   -82.922307
2024-12-31     3.377212      4.274017   -89.680496
</pre></div>
</div>
<img alt="../_images/2a520079010f3e9784fdfb70e1bc557986e37dfaef5c649b8c1dd50852ccc130.png" src="../_images/2a520079010f3e9784fdfb70e1bc557986e37dfaef5c649b8c1dd50852ccc130.png" />
<img alt="../_images/e61567d7465341df70c171383a0602e180486de62fa91a131c3ed33fcf9ac34e.png" src="../_images/e61567d7465341df70c171383a0602e180486de62fa91a131c3ed33fcf9ac34e.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>All computations completed successfully.
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="exploring-the-functions-visual-understanding-of-implied-forward-rate-calculation">
<h1>Exploring the Functions: Visual Understanding of Implied Forward Rate Calculation<a class="headerlink" href="#exploring-the-functions-visual-understanding-of-implied-forward-rate-calculation" title="Link to this heading">#</a></h1>
<p>This notebook provides a step-by-step exploration of each function in the implied forward rate calculation process, with visualizations and tables to help build intuition about what’s happening at each stage.</p>
<ol class="arabic simple">
<li><p>Data loading and preprocessing</p></li>
<li><p>Daily dividend accumulation</p></li>
<li><p>Barndorff-Nielsen outlier filtering mechanism</p></li>
<li><p>The forward rate calculation process</p></li>
<li><p>Visualization of results</p></li>
</ol>
<p>Let’s break down each component visually to understand the theory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Function to visualize and explain daily dividends</span>
<span class="k">def</span><span class="w"> </span><span class="nf">explore_daily_dividends</span><span class="p">(</span><span class="n">index_code</span><span class="o">=</span><span class="s2">&quot;SPX&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Explore and visualize how the daily dividend function works</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== Exploring build_daily_dividends for </span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2"> ===&quot;</span><span class="p">)</span>
    
    <span class="c1"># Load the data</span>
    <span class="n">input_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">INPUT_DIR</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;bloomberg_historical_data.parquet&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">input_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">input_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">DATA_MANUAL</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;bloomberg_historical_data.parquet&quot;</span>
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">input_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No Bloomberg data file found. Cannot proceed with exploration.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="c1"># Load raw data</span>
    <span class="n">raw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>
    
    <span class="c1"># Show the structure of the raw dataframe</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Raw Bloomberg data structure:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape: </span><span class="si">{</span><span class="n">raw_df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Column structure (MultiIndex):&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">raw_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>  <span class="c1"># Show first 10 columns</span>
    
    <span class="c1"># Extract dividend column</span>
    <span class="n">div_col</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2"> Index&quot;</span><span class="p">,</span> <span class="s2">&quot;INDX_GROSS_DAILY_DIV&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">div_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">raw_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing dividend column for </span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">. Trying a different approach...&quot;</span><span class="p">)</span>
        <span class="c1"># Try to find any dividend-related columns</span>
        <span class="n">div_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">raw_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;DIV&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">div_cols</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found potential dividend columns: </span><span class="si">{</span><span class="n">div_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">div_col</span> <span class="o">=</span> <span class="n">div_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No dividend columns found in the data.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    
    <span class="c1"># Process dividends as in the original function</span>
    <span class="n">div_df</span> <span class="o">=</span> <span class="n">raw_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">div_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s2">&quot;Daily_Div&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">div_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;Date&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
    <span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;Daily_Div&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;Daily_Div&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">div_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">div_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">div_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Create cumulative sum column</span>
    <span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;CumDiv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;Daily_Div&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    
    <span class="c1"># Display processed data</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processed dividend data (first 5 rows):&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">div_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
    
    <span class="c1"># Visualize daily dividends</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    
    <span class="c1"># Subplot 1: Daily dividends over time</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;Daily_Div&quot;</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2"> Daily Dividends&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Daily Div Amount&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># Subplot 2: Cumulative dividends</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;CumDiv&quot;</span><span class="p">],</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2"> Cumulative Dividends&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative Div&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c1"># Summary statistics</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Dividend Data Summary:&quot;</span><span class="p">)</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;Daily_Div&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
    <span class="n">display</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
    
    <span class="c1"># Show time periods with zero and non-zero dividends</span>
    <span class="n">zero_div</span> <span class="o">=</span> <span class="n">div_df</span><span class="p">[</span><span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;Daily_Div&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">div_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Days with zero dividends: </span><span class="si">{</span><span class="n">zero_div</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">zero_div</span><span class="o">/</span><span class="n">total</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> of total)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Days with non-zero dividends: </span><span class="si">{</span><span class="n">total</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zero_div</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="p">(</span><span class="n">total</span><span class="o">-</span><span class="n">zero_div</span><span class="p">)</span><span class="o">/</span><span class="n">total</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> of total)&quot;</span><span class="p">)</span>
    
    <span class="c1"># Monthly dividend patterns (Useful to see if there are dividend seasons)</span>
    <span class="n">div_df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">div_df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
    <span class="n">div_df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">div_df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
    
    <span class="n">monthly_pattern</span> <span class="o">=</span> <span class="n">div_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">)[</span><span class="s1">&#39;Daily_Div&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">monthly_pattern</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;teal&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2"> Average Daily Dividend by Month&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Month&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Average Daily Dividend&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;Jan&#39;</span><span class="p">,</span> <span class="s1">&#39;Feb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mar&#39;</span><span class="p">,</span> <span class="s1">&#39;Apr&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;Jun&#39;</span><span class="p">,</span> <span class="s1">&#39;Jul&#39;</span><span class="p">,</span> <span class="s1">&#39;Aug&#39;</span><span class="p">,</span> <span class="s1">&#39;Sep&#39;</span><span class="p">,</span> <span class="s1">&#39;Oct&#39;</span><span class="p">,</span> <span class="s1">&#39;Nov&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">div_df</span>

<span class="c1"># Run the exploration</span>
<span class="n">spx_div_df</span> <span class="o">=</span> <span class="n">explore_daily_dividends</span><span class="p">(</span><span class="s2">&quot;SPX&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== Exploring build_daily_dividends for SPX ===

Raw Bloomberg data structure:
Shape: (3913, 62)
Column structure (MultiIndex):
MultiIndex([( &#39;SPX Index&#39;,              &#39;PX_LAST&#39;),
            ( &#39;SPX Index&#39;,      &#39;IDX_EST_DVD_YLD&#39;),
            ( &#39;SPX Index&#39;, &#39;INDX_GROSS_DAILY_DIV&#39;),
            ( &#39;NDX Index&#39;,              &#39;PX_LAST&#39;),
            ( &#39;NDX Index&#39;,      &#39;IDX_EST_DVD_YLD&#39;),
            ( &#39;NDX Index&#39;, &#39;INDX_GROSS_DAILY_DIV&#39;),
            (&#39;INDU Index&#39;,              &#39;PX_LAST&#39;),
            (&#39;INDU Index&#39;,      &#39;IDX_EST_DVD_YLD&#39;),
            (&#39;INDU Index&#39;, &#39;INDX_GROSS_DAILY_DIV&#39;),
            ( &#39;ES1 Index&#39;,              &#39;PX_LAST&#39;)],
           )

Processed dividend data (first 5 rows):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Daily_Div</th>
      <th>CumDiv</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2010-01-01</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2010-01-04</td>
      <td>0.058362</td>
      <td>0.058362</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-05</td>
      <td>0.001744</td>
      <td>0.060106</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-06</td>
      <td>0.497980</td>
      <td>0.558086</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2010-01-07</td>
      <td>0.061819</td>
      <td>0.619905</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/581c63f4f871082a9fc55f1a85980baa1439a1990b5d437b523051342a94af49.png" src="../_images/581c63f4f871082a9fc55f1a85980baa1439a1990b5d437b523051342a94af49.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dividend Data Summary:
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count    3913.000000
mean        0.186435
std         0.228265
min         0.000000
25%         0.022825
50%         0.095385
75%         0.271259
max         1.604820
Name: Daily_Div, dtype: float64
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Days with zero dividends: 447 (11.4% of total)
Days with non-zero dividends: 3466 (88.6% of total)
</pre></div>
</div>
<img alt="../_images/fa4eb064c67ae32c5ba5164313219166325f171e0f4496dc4b4b4627dd7d9040.png" src="../_images/fa4eb064c67ae32c5ba5164313219166325f171e0f4496dc4b4b4627dd7d9040.png" />
</div>
</div>
<section id="understanding-daily-dividends">
<h2>Understanding Daily Dividends<a class="headerlink" href="#understanding-daily-dividends" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">build_daily_dividends()</span></code> function extracts daily dividend information from the Bloomberg data and prepares it for use in the forward rate calculations.</p>
<p>Key observations:</p>
<ol class="arabic simple">
<li><p>The function extracts a specific column from a multi-index DataFrame</p></li>
<li><p>It converts dates, fills missing values with zeros, and sorts by date</p></li>
<li><p>Daily dividends are typically sparse - many days have zero dividends</p></li>
<li><p>The cumulative dividend is critical for the forward rate calculation</p></li>
<li><p>There may be seasonal patterns in dividend payments</p></li>
</ol>
<p>The visualizations show both the daily dividend amounts (which are typically spiky) and the cumulative dividends (which grow over time). The monthly pattern chart helps identify any seasonality in dividend payments.</p>
<p>These dividend values will be used in the <code class="docutils literal notranslate"><span class="pre">Div_Sum1</span></code> and <code class="docutils literal notranslate"><span class="pre">Div_Sum2</span></code> calculations, which represent the expected dividends between the current date and the settlement dates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">explore_barndorff_nielsen_filter</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Demonstrate how the Barndorff-Nielsen outlier filter works with a synthetic dataset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Exploring Barndorff-Nielsen Filter ===&quot;</span><span class="p">)</span>
    
    <span class="c1"># Create a synthetic time series with some outliers</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2020-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    
    <span class="c1"># Base series with some seasonality and trend</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
    
    <span class="c1"># Add noise</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    
    <span class="c1"># Add outliers</span>
    <span class="n">outliers_idx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">190</span><span class="p">]</span>
    <span class="n">outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">outliers_idx</span><span class="p">:</span>
        <span class="n">outliers</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    
    <span class="c1"># Combined series</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">noise</span> <span class="o">+</span> <span class="n">outliers</span>
    
    <span class="c1"># Create DataFrame</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">values</span>
    <span class="p">})</span>
    
    <span class="c1"># Visualize the original series</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">outliers_idx</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Synthetic Time Series with Outliers&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c1"># Apply the Barndorff-Nielsen filter</span>
    <span class="n">window</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Smaller window for demonstration</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="mf">3.0</span>  <span class="c1"># Lower threshold to catch all our synthetic outliers</span>
    
    <span class="c1"># Sort the data</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    
    <span class="c1"># Calculate rolling median</span>
    <span class="n">rolling_median</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="n">rolling_median_shifted</span> <span class="o">=</span> <span class="n">rolling_median</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Calculate absolute deviation</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;abs_dev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">rolling_median_shifted</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
    
    <span class="c1"># Calculate rolling MAD (Mean Absolute Deviation)</span>
    <span class="n">rolling_mad</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;abs_dev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">rolling_mad_shifted</span> <span class="o">=</span> <span class="n">rolling_mad</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Calculate standardized deviation</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;std_dev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;abs_dev&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">rolling_mad_shifted</span>
    
    <span class="c1"># Determine outliers</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_outlier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;std_dev&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="s1">&#39;is_outlier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="c1"># Create filtered series</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value_filtered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_outlier&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    
    <span class="c1"># Show step-by-step calculations for better understanding</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Step-by-step filter process (showing sample rows):&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;abs_dev&#39;</span><span class="p">,</span> <span class="s1">&#39;std_dev&#39;</span><span class="p">,</span> <span class="s1">&#39;is_outlier&#39;</span><span class="p">,</span> <span class="s1">&#39;value_filtered&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">25</span><span class="p">])</span>
    
    <span class="c1"># Visualize the filtering steps</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Original with rolling median</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span> <span class="n">rolling_median</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Rolling Median&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">outliers_idx</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original Series with Rolling Median&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="c1"># Absolute Deviation and Mean Absolute Deviation</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;abs_dev&#39;</span><span class="p">],</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Absolute Deviation&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span> <span class="n">rolling_mad</span><span class="p">,</span> <span class="s1">&#39;m-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean Absolute Deviation&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Absolute Deviation and MAD&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="c1"># Standardized Deviation with Threshold</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;std_dev&#39;</span><span class="p">],</span> <span class="s1">&#39;c-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Standardized Deviation&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Threshold (</span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">outliers_idx</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="ow">and</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_outlier&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;std_dev&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Standardized Deviation with Outlier Threshold&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c1"># Compare original vs filtered</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value_filtered&#39;</span><span class="p">],</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Filtered&#39;</span><span class="p">)</span>
    <span class="n">detected_outliers</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_outlier&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">][</span><span class="n">detected_outliers</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="n">detected_outliers</span><span class="p">],</span> 
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Detected Outliers&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Original vs Filtered Time Series&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c1"># Summary of outlier detection</span>
    <span class="n">detected_count</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_outlier&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Summary: Detected </span><span class="si">{</span><span class="n">detected_count</span><span class="si">}</span><span class="s2"> outliers out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> observations&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check how many of our artificial outliers were detected</span>
    <span class="n">true_positive</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">outliers_idx</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="ow">and</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_outlier&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
            <span class="n">true_positive</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;True outliers detected: </span><span class="si">{</span><span class="n">true_positive</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">outliers_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outliers_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detection rate: </span><span class="si">{</span><span class="n">true_positive</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">outliers_idx</span><span class="p">)</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span>

<span class="c1"># Run the exploration</span>
<span class="n">bn_filter_df</span> <span class="o">=</span> <span class="n">explore_barndorff_nielsen_filter</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== Exploring Barndorff-Nielsen Filter ===
</pre></div>
</div>
<img alt="../_images/a2672c90f76a01f1f3f432530e85704ccbf377cd06cca689d5fd812f28926941.png" src="../_images/a2672c90f76a01f1f3f432530e85704ccbf377cd06cca689d5fd812f28926941.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Step-by-step filter process (showing sample rows):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>value</th>
      <th>abs_dev</th>
      <th>std_dev</th>
      <th>is_outlier</th>
      <th>value_filtered</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>15</th>
      <td>2020-01-16</td>
      <td>1.841408</td>
      <td>0.103501</td>
      <td>0.197860</td>
      <td>False</td>
      <td>1.841408</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2020-01-17</td>
      <td>1.737907</td>
      <td>0.103501</td>
      <td>0.203625</td>
      <td>False</td>
      <td>1.737907</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2020-01-18</td>
      <td>2.519580</td>
      <td>0.661327</td>
      <td>1.311529</td>
      <td>False</td>
      <td>2.519580</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2020-01-19</td>
      <td>2.022771</td>
      <td>0.141783</td>
      <td>0.284550</td>
      <td>False</td>
      <td>2.022771</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2020-01-20</td>
      <td>1.880988</td>
      <td>0.141783</td>
      <td>0.289496</td>
      <td>False</td>
      <td>1.880988</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2020-01-21</td>
      <td>7.071302</td>
      <td>4.797679</td>
      <td>9.889070</td>
      <td>True</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2020-01-22</td>
      <td>2.682461</td>
      <td>0.162881</td>
      <td>0.345661</td>
      <td>False</td>
      <td>2.682461</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2020-01-23</td>
      <td>2.926694</td>
      <td>0.265088</td>
      <td>0.501126</td>
      <td>False</td>
      <td>2.926694</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2020-01-24</td>
      <td>2.273623</td>
      <td>0.408838</td>
      <td>0.746192</td>
      <td>False</td>
      <td>2.273623</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2020-01-25</td>
      <td>2.802253</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>False</td>
      <td>2.802253</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/3cffcb8651893062c32c83f96f1d412978751536fa48838b915986b0ed788dde.png" src="../_images/3cffcb8651893062c32c83f96f1d412978751536fa48838b915986b0ed788dde.png" />
<img alt="../_images/9382f5d3c79711c5a5282db05e09f7fa1700b910f070bab796e7c7fc527f047e.png" src="../_images/9382f5d3c79711c5a5282db05e09f7fa1700b910f070bab796e7c7fc527f047e.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Summary: Detected 9 outliers out of 200 observations
True outliers detected: 6 out of 6
Detection rate: 100.0%
</pre></div>
</div>
</div>
</div>
</section>
<section id="understanding-barndorff-nielsen-outlier-filter">
<h2>Understanding Barndorff-Nielsen Outlier Filter<a class="headerlink" href="#understanding-barndorff-nielsen-outlier-filter" title="Link to this heading">#</a></h2>
<p>The Barndorff-Nielsen filter is a robust statistical method for detecting and removing outliers in time series data. Following the paper’s methedology:</p>
<ol class="arabic simple">
<li><p><strong>Rolling Median Calculation</strong>:</p>
<ul class="simple">
<li><p>For each point, calculate the median value within a window (±45 days by default)</p></li>
<li><p>This establishes a robust estimate of the “normal” value at each point</p></li>
</ul>
</li>
<li><p><strong>Absolute Deviation</strong>:</p>
<ul class="simple">
<li><p>Calculate how far each value deviates from the rolling median</p></li>
<li><p>The shift(1) ensures we’re using previously known information</p></li>
</ul>
</li>
<li><p><strong>Mean Absolute Deviation (MAD)</strong>:</p>
<ul class="simple">
<li><p>Calculate the average of absolute deviations within the window</p></li>
<li><p>This establishes what constitutes a “normal” amount of deviation</p></li>
</ul>
</li>
<li><p><strong>Standardized Deviation</strong>:</p>
<ul class="simple">
<li><p>Divide each absolute deviation by the MAD</p></li>
<li><p>This creates a standardized measure of how unusual each deviation is</p></li>
</ul>
</li>
<li><p><strong>Outlier Detection</strong>:</p>
<ul class="simple">
<li><p>Points where standardized deviation ≥ threshold (default 10.0) are marked as outliers</p></li>
<li><p>These points are replaced with NaN in the filtered series</p></li>
</ul>
</li>
</ol>
<p>The filter is particularly useful for financial time series where sudden jumps can occur due to data errors or extreme market events that shouldn’t influence calculations of normal behavior.</p>
<p>In the spread calculation, this prevents outliers from distorting the implied forward rates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">explore_forward_rate_calculation</span><span class="p">(</span><span class="n">index_code</span><span class="o">=</span><span class="s2">&quot;SPX&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Explore the steps of the forward rate calculation visually</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== Exploring Forward Rate Calculation for </span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2"> ===&quot;</span><span class="p">)</span>
    
    <span class="c1"># Load necessary data</span>
    <span class="n">fut_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">PROCESSED_DIR</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">_Calendar_spread.csv&quot;</span>
    <span class="n">ois_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">PROCESSED_DIR</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;cleaned_ois_rates.csv&quot;</span>
    
    <span class="c1"># Check if files exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fut_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ois_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Required data files not found. Cannot proceed with exploration.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="c1"># Load calendar spreads</span>
    <span class="n">fut_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fut_file</span><span class="p">)</span>
    <span class="n">fut_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">fut_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
    <span class="n">fut_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fut_df</span><span class="p">[</span><span class="s2">&quot;Term1_SettlementDate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">fut_df</span><span class="p">[</span><span class="s2">&quot;Term1_SettlementDate&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
    <span class="n">fut_df</span><span class="p">[</span><span class="s2">&quot;Term2_SettlementDate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">fut_df</span><span class="p">[</span><span class="s2">&quot;Term2_SettlementDate&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
    <span class="n">fut_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Display calendar spread data</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Futures Calendar Spread data (first 5 rows):&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">fut_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
    
    <span class="c1"># Load OIS rates</span>
    <span class="n">ois_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ois_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;Date&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ois_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">ois_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Unnamed: 0&quot;</span><span class="p">:</span> <span class="s2">&quot;Date&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ois_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ois_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
    <span class="n">ois_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Display OIS rates</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">OIS rates data (first 5 rows):&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">ois_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
    
    <span class="c1"># Chart the OIS rates</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ois_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">ois_df</span><span class="p">[</span><span class="s2">&quot;OIS_3M&quot;</span><span class="p">],</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;3-Month OIS Rates Over Time&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;OIS Rate (%)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c1"># Merge futures and OIS data</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
        <span class="n">fut_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">),</span>
        <span class="n">ois_df</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;backward&quot;</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="s2">&quot;OIS_3M&quot;</span> <span class="ow">in</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">merged_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;OIS_3M&quot;</span><span class="p">:</span> <span class="s2">&quot;OIS&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Load dividends</span>
    <span class="n">div_df</span> <span class="o">=</span> <span class="n">build_daily_dividends</span><span class="p">(</span><span class="n">index_code</span><span class="p">)</span>
    <span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;CumDiv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">div_df</span><span class="p">[</span><span class="s2">&quot;Daily_Div&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    
    <span class="c1"># Merge with current date cumulative dividends</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
        <span class="n">merged_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">),</span>
        <span class="n">div_df</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;CumDiv&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">),</span>
        <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;backward&quot;</span>
    <span class="p">)</span>
    <span class="n">merged_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;CumDiv&quot;</span><span class="p">:</span> <span class="s2">&quot;CumDiv_current&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Merge with Term1 and Term2 settlement date cumulative dividends</span>
    <span class="n">t1_df</span> <span class="o">=</span> <span class="n">div_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Date&quot;</span><span class="p">:</span> <span class="s2">&quot;Term1_SettlementDate&quot;</span><span class="p">,</span> <span class="s2">&quot;CumDiv&quot;</span><span class="p">:</span> <span class="s2">&quot;CumDiv_Term1&quot;</span><span class="p">})</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
        <span class="n">merged_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Term1_SettlementDate&quot;</span><span class="p">),</span>
        <span class="n">t1_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Term1_SettlementDate&quot;</span><span class="p">),</span>
        <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Term1_SettlementDate&quot;</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;backward&quot;</span>
    <span class="p">)</span>
    
    <span class="n">t2_df</span> <span class="o">=</span> <span class="n">div_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Date&quot;</span><span class="p">:</span> <span class="s2">&quot;Term2_SettlementDate&quot;</span><span class="p">,</span> <span class="s2">&quot;CumDiv&quot;</span><span class="p">:</span> <span class="s2">&quot;CumDiv_Term2&quot;</span><span class="p">})</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
        <span class="n">merged_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Term2_SettlementDate&quot;</span><span class="p">),</span>
        <span class="n">t2_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Term2_SettlementDate&quot;</span><span class="p">),</span>
        <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Term2_SettlementDate&quot;</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;backward&quot;</span>
    <span class="p">)</span>
    
    <span class="c1"># Calculate dividend sums</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Div_Sum1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;CumDiv_Term1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;CumDiv_current&quot;</span><span class="p">]</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Div_Sum2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;CumDiv_Term2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;CumDiv_current&quot;</span><span class="p">]</span>
    
    <span class="c1"># Display intermediate calculation</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Intermediate calculation with dividend sums (sample rows):&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">merged_df</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Term1_TTM&quot;</span><span class="p">,</span> <span class="s2">&quot;Term2_TTM&quot;</span><span class="p">,</span> <span class="s2">&quot;Term1_Futures_Price&quot;</span><span class="p">,</span> 
                      <span class="s2">&quot;Term2_Futures_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;OIS&quot;</span><span class="p">,</span> <span class="s2">&quot;Div_Sum1&quot;</span><span class="p">,</span> <span class="s2">&quot;Div_Sum2&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
    
    <span class="c1"># Remove rows with missing TTM or price data</span>
    <span class="n">merged_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Term1_TTM&quot;</span><span class="p">,</span> <span class="s2">&quot;Term2_TTM&quot;</span><span class="p">,</span> <span class="s2">&quot;Term1_Futures_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Term2_Futures_Price&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Step-by-step calculation visualization</span>
    
    <span class="c1"># 1. Compounding dividends</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Div_Sum1_Comp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Div_Sum1&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="p">((</span><span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Term1_TTM&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">360.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;OIS&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span>
    <span class="p">)</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Div_Sum2_Comp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Div_Sum2&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="p">((</span><span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Term2_TTM&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">360.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;OIS&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span>
    <span class="p">)</span>
    
    <span class="c1"># Show effect of compounding</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Effect of compounding on dividends (sample rows):&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">merged_df</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Div_Sum1&quot;</span><span class="p">,</span> <span class="s2">&quot;Div_Sum1_Comp&quot;</span><span class="p">,</span> <span class="s2">&quot;Div_Sum2&quot;</span><span class="p">,</span> <span class="s2">&quot;Div_Sum2_Comp&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
    
    <span class="c1"># 2. Implied forward rate calculation</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;implied_forward_raw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Term2_Futures_Price&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Div_Sum2_Comp&quot;</span><span class="p">])</span> <span class="o">/</span>
        <span class="p">(</span><span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Term1_Futures_Price&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Div_Sum1_Comp&quot;</span><span class="p">])</span>
        <span class="o">-</span> <span class="mf">1.0</span>
    <span class="p">)</span>
    
    <span class="n">dt</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Term2_TTM&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Term1_TTM&quot;</span><span class="p">]</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cal_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">_rf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="mf">100.0</span> <span class="o">*</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;implied_forward_raw&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">360.0</span> <span class="o">/</span> <span class="n">dt</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="p">)</span>
    
    <span class="c1"># 3. OIS-implied forward rate</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;ois_fwd_raw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;OIS&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Term2_TTM&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">360.0</span><span class="p">)</span> <span class="o">/</span>
        <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;OIS&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;Term1_TTM&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">360.0</span><span class="p">)</span>
        <span class="o">-</span> <span class="mf">1.0</span>
    <span class="p">)</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ois_fwd_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;ois_fwd_raw&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">360.0</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="p">)</span>
    
    <span class="c1"># 4. Spread calculation</span>
    <span class="n">spread_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;spread_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="n">spread_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cal_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">_rf&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">merged_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ois_fwd_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    
    <span class="c1"># Show forward rate calculations</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Forward rate calculations (sample rows):&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">merged_df</span><span class="p">[[</span>
        <span class="s2">&quot;Date&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;implied_forward_raw&quot;</span><span class="p">,</span> 
        <span class="sa">f</span><span class="s2">&quot;cal_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">_rf&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;ois_fwd_raw&quot;</span><span class="p">,</span> 
        <span class="sa">f</span><span class="s2">&quot;ois_fwd_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
        <span class="n">spread_col</span>
    <span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
    
    <span class="c1"># Apply Barndorff-Nielsen filter</span>
    <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">barndorff_nielsen_filter</span><span class="p">(</span><span class="n">merged_df</span><span class="p">,</span> <span class="n">spread_col</span><span class="p">,</span> <span class="n">date_col</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    
    <span class="c1"># Set outliers to NaN</span>
    <span class="n">out_mask</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spread_col</span><span class="si">}</span><span class="s2">_filtered&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
    <span class="n">filtered_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">out_mask</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cal_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">_rf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">filtered_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">out_mask</span><span class="p">,</span> <span class="n">spread_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="c1"># Multiply spread by 100 for bps</span>
    <span class="n">filtered_df</span><span class="p">[</span><span class="n">spread_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="p">[</span><span class="n">spread_col</span><span class="p">]</span> <span class="o">*</span> <span class="mf">100.0</span>
    
    <span class="c1"># Set index to Date for time series plots</span>
    <span class="n">filtered_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Visualize the forward rates and spread</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
    
    <span class="c1"># Plot 1: Implied Forward Rate</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">filtered_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">filtered_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cal_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">_rf&quot;</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2"> Implied Forward Rate&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Rate (%)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># Plot 2: OIS Forward Rate</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">filtered_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">filtered_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ois_fwd_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2"> OIS-Implied Forward Rate&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Rate (%)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># Plot 3: Spread</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">filtered_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">filtered_df</span><span class="p">[</span><span class="n">spread_col</span><span class="p">],</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2"> Forward Rate Spread (bps)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Spread (bps)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c1"># Visualize the term structure</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    
    <span class="c1"># Get a sample date for demonstration</span>
    <span class="n">sample_date</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># Middle of the dataset</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Term structure visualization for date: </span><span class="si">{</span><span class="n">sample_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Filter for a reasonable window around the sample date</span>
    <span class="n">date_window</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Days</span>
    <span class="n">sample_window</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_indexer</span><span class="p">([</span><span class="n">sample_date</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sample_window_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sample_window</span> <span class="o">-</span> <span class="n">date_window</span><span class="p">)</span>
    <span class="n">sample_window_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">),</span> <span class="n">sample_window</span> <span class="o">+</span> <span class="n">date_window</span><span class="p">)</span>
    
    <span class="n">sample_data</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sample_window_start</span><span class="p">:</span><span class="n">sample_window_end</span><span class="p">]</span>
    
    <span class="c1"># Plot term structure</span>
    <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">sample_data</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Term1_TTM&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cal_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">_rf&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Near Term&#39;</span> <span class="k">if</span> <span class="n">date</span> <span class="o">==</span> <span class="n">sample_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Term2_TTM&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ois_fwd_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Far Term&#39;</span> <span class="k">if</span> <span class="n">date</span> <span class="o">==</span> <span class="n">sample_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="c1"># Connect the points with a line</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Term1_TTM&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Term2_TTM&quot;</span><span class="p">]],</span> 
                 <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cal_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">_rf&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ois_fwd_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]],</span> 
                 <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2"> Forward Rate Term Structure&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time to Maturity (days)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Forward Rate (%)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">filtered_df</span>

<span class="c1"># Run the exploration</span>
<span class="n">forward_rate_df</span> <span class="o">=</span> <span class="n">explore_forward_rate_calculation</span><span class="p">(</span><span class="s2">&quot;SPX&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== Exploring Forward Rate Calculation for SPX ===

Futures Calendar Spread data (first 5 rows):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Term1_Futures_Price</th>
      <th>Term1_Volume</th>
      <th>Term1_OpenInterest</th>
      <th>Term1_ContractSpec</th>
      <th>Term1_SettlementDate</th>
      <th>Term1_TTM</th>
      <th>Term2_Futures_Price</th>
      <th>Term2_Volume</th>
      <th>Term2_OpenInterest</th>
      <th>Term2_ContractSpec</th>
      <th>Term2_SettlementDate</th>
      <th>Term2_TTM</th>
      <th>Index</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2010-01-04</td>
      <td>1128.75</td>
      <td>1282633.0</td>
      <td>2440458.0</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>74.0</td>
      <td>1124.00</td>
      <td>1641.0</td>
      <td>3354.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>165.0</td>
      <td>SPX</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2010-01-05</td>
      <td>1132.25</td>
      <td>1368386.0</td>
      <td>2402850.0</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>73.0</td>
      <td>1127.50</td>
      <td>686.0</td>
      <td>3432.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>164.0</td>
      <td>SPX</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-06</td>
      <td>1133.00</td>
      <td>1252015.0</td>
      <td>2396493.0</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>72.0</td>
      <td>1128.00</td>
      <td>1163.0</td>
      <td>3713.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>163.0</td>
      <td>SPX</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-07</td>
      <td>1137.50</td>
      <td>1553963.0</td>
      <td>2406352.0</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>71.0</td>
      <td>1132.50</td>
      <td>1135.0</td>
      <td>4154.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>162.0</td>
      <td>SPX</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2010-01-08</td>
      <td>1141.50</td>
      <td>1508175.0</td>
      <td>2758348.0</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>70.0</td>
      <td>1136.75</td>
      <td>1080.0</td>
      <td>17466.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>161.0</td>
      <td>SPX</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>OIS rates data (first 5 rows):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>OIS_3M</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2010-01-01</td>
      <td>0.00162</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2010-01-04</td>
      <td>0.00162</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-05</td>
      <td>0.00155</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-06</td>
      <td>0.00146</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2010-01-07</td>
      <td>0.00145</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/9a360224e7ae98d9a6b3b6f56b419ea6cc728da2c468e223725525570e1af0e2.png" src="../_images/9a360224e7ae98d9a6b3b6f56b419ea6cc728da2c468e223725525570e1af0e2.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[SPX] Building daily dividend table
Primary input file not found, switching to cached data
[SPX] daily dividends final shape: (3913, 2)
[SPX] Sample daily dividends:
        Date  Daily_Div
0 2010-01-01   0.000000
1 2010-01-04   0.058362
2 2010-01-05   0.001744
3 2010-01-06   0.497980
4 2010-01-07   0.061819
5 2010-01-08   0.000000
6 2010-01-11   0.000000
7 2010-01-12   0.000000
8 2010-01-13   0.113508
9 2010-01-14   0.021957

Intermediate calculation with dividend sums (sample rows):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Term1_TTM</th>
      <th>Term2_TTM</th>
      <th>Term1_Futures_Price</th>
      <th>Term2_Futures_Price</th>
      <th>OIS</th>
      <th>Div_Sum1</th>
      <th>Div_Sum2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2010-01-04</td>
      <td>74.0</td>
      <td>165.0</td>
      <td>1128.75</td>
      <td>1124.00</td>
      <td>0.00162</td>
      <td>4.840390</td>
      <td>10.382986</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2010-01-05</td>
      <td>73.0</td>
      <td>164.0</td>
      <td>1132.25</td>
      <td>1127.50</td>
      <td>0.00155</td>
      <td>4.838646</td>
      <td>10.381242</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-06</td>
      <td>72.0</td>
      <td>163.0</td>
      <td>1133.00</td>
      <td>1128.00</td>
      <td>0.00146</td>
      <td>4.340666</td>
      <td>9.883262</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-07</td>
      <td>71.0</td>
      <td>162.0</td>
      <td>1137.50</td>
      <td>1132.50</td>
      <td>0.00145</td>
      <td>4.278847</td>
      <td>9.821443</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2010-01-08</td>
      <td>70.0</td>
      <td>161.0</td>
      <td>1141.50</td>
      <td>1136.75</td>
      <td>0.00143</td>
      <td>4.278847</td>
      <td>9.821443</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Effect of compounding on dividends (sample rows):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Div_Sum1</th>
      <th>Div_Sum1_Comp</th>
      <th>Div_Sum2</th>
      <th>Div_Sum2_Comp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2010-01-04</td>
      <td>4.840390</td>
      <td>4.841196</td>
      <td>10.382986</td>
      <td>10.386841</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2010-01-05</td>
      <td>4.838646</td>
      <td>4.839406</td>
      <td>10.381242</td>
      <td>10.384907</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-06</td>
      <td>4.340666</td>
      <td>4.341300</td>
      <td>9.883262</td>
      <td>9.886529</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-07</td>
      <td>4.278847</td>
      <td>4.279459</td>
      <td>9.821443</td>
      <td>9.824647</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2010-01-08</td>
      <td>4.278847</td>
      <td>4.279442</td>
      <td>9.821443</td>
      <td>9.824584</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Forward rate calculations (sample rows):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>implied_forward_raw</th>
      <th>cal_SPX_rf</th>
      <th>ois_fwd_raw</th>
      <th>ois_fwd_SPX</th>
      <th>spread_SPX</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2010-01-04</td>
      <td>0.000702</td>
      <td>0.277667</td>
      <td>0.000409</td>
      <td>0.161946</td>
      <td>0.115721</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2010-01-05</td>
      <td>0.000700</td>
      <td>0.276762</td>
      <td>0.000392</td>
      <td>0.154951</td>
      <td>0.121811</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-06</td>
      <td>0.000479</td>
      <td>0.189648</td>
      <td>0.000369</td>
      <td>0.145957</td>
      <td>0.043691</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-07</td>
      <td>0.000477</td>
      <td>0.188897</td>
      <td>0.000366</td>
      <td>0.144959</td>
      <td>0.043939</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2010-01-08</td>
      <td>0.000694</td>
      <td>0.274539</td>
      <td>0.000361</td>
      <td>0.142960</td>
      <td>0.131579</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Barndorff-Nielsen filter: flagged 47 outliers in spread_SPX
</pre></div>
</div>
<img alt="../_images/f74fad160c1c1f966e37ff25f0d72630c5648efe9b128cf707727ca48aa4b9ab.png" src="../_images/f74fad160c1c1f966e37ff25f0d72630c5648efe9b128cf707727ca48aa4b9ab.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Term structure visualization for date: 2017-06-30 00:00:00
</pre></div>
</div>
<img alt="../_images/ba52928216466cfe8ae7e8f42465b3b3d90a4d8660d2f7787b0888f9ab069417.png" src="../_images/ba52928216466cfe8ae7e8f42465b3b3d90a4d8660d2f7787b0888f9ab069417.png" />
</div>
</div>
</section>
<section id="understanding-the-forward-rate-calculation-process">
<h2>Understanding the Forward Rate Calculation Process<a class="headerlink" href="#understanding-the-forward-rate-calculation-process" title="Link to this heading">#</a></h2>
<p>When computing <strong>equity spot-futures arbitrage</strong> for an index ( S_t ) paying dividends from ( t ) to ( t + \tau ), we combine:</p>
<ul class="simple">
<li><p><strong>Futures Prices</strong> (from the nearest and next-nearest futures contracts)</p></li>
<li><p><strong>OIS Rates</strong> (as a proxy for the risk-free rate)</p></li>
<li><p><strong>Realized Dividends</strong> (as a simple forecast of expected dividends)</p></li>
</ul>
<p>These are merged into a single DataFrame, from which we derive an <strong>implied forward rate</strong> ( \cal{rf} ) and compare it with the <strong>OIS-implied forward rate</strong> to compute an <strong>arbitrage spread</strong>.</p>
<section id="data-preparation-merging">
<h3>1. Data Preparation &amp; Merging<a class="headerlink" href="#data-preparation-merging" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Calendar Spread Data</strong><br />
Provides columns for:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Term1_Futures_Price</span></code> and <code class="docutils literal notranslate"><span class="pre">Term2_Futures_Price</span></code> (prices for near-term and deferred futures)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Term1_SettlementDate</span></code> and <code class="docutils literal notranslate"><span class="pre">Term2_SettlementDate</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Term1_TTM</span></code> and <code class="docutils literal notranslate"><span class="pre">Term2_TTM</span></code> (time-to-maturity in days)</p></li>
</ul>
</li>
<li><p><strong>OIS Rates</strong><br />
Contains daily 3-month OIS rates, merged into the calendar spread data via an as-of backward merge on <code class="docutils literal notranslate"><span class="pre">Date</span></code>.</p></li>
<li><p><strong>Dividends</strong></p>
<ul class="simple">
<li><p>We accumulate daily dividends into a <code class="docutils literal notranslate"><span class="pre">CumDiv</span></code> series.</p></li>
<li><p>Merged at both the <strong>current date</strong> and each <strong>futures settlement date</strong> to approximate how much dividend would be paid between now and each maturity.</p></li>
</ul>
</li>
</ol>
</section>
<section id="dividend-sums">
<h3>2. Dividend Sums<a class="headerlink" href="#dividend-sums" title="Link to this heading">#</a></h3>
<p>Let:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\( \text{CumDiv}_\text{current} \)</span> = cumulative dividend at the current date</p></li>
<li><p><span class="math notranslate nohighlight">\( \text{CumDiv}_{\text{Term1}} \)</span> = cumulative dividend at the Term1 settlement date</p></li>
<li><p><span class="math notranslate nohighlight">\( \text{CumDiv}_{\text{Term2}} \)</span> = cumulative dividend at the Term2 settlement date</p></li>
</ul>
<p>Then:</p>
<div class="math notranslate nohighlight">
\[
\text{Div\_Sum1} = \text{CumDiv}_{\text{Term1}} - \text{CumDiv}_\text{current},
\quad
\text{Div\_Sum2} = \text{CumDiv}_{\text{Term2}} - \text{CumDiv}_\text{current}.
\]</div>
</section>
<section id="dividend-compounding">
<h3>3. Dividend Compounding<a class="headerlink" href="#dividend-compounding" title="Link to this heading">#</a></h3>
<p>We apply a <strong>half-interval compounding</strong> for each dividend sum:</p>
<div class="math notranslate nohighlight">
\[
\text{Div\_Sum1\_Comp} \;=\; \text{Div\_Sum1} \times
\Bigl(\bigl(\tfrac{\text{Term1\_TTM}}{2 \times 360}\bigr) \times \text{OIS} \;+\; 1.0\Bigr).
\]</div>
<div class="math notranslate nohighlight">
\[
\text{Div\_Sum2\_Comp} \;=\; \text{Div\_Sum2} \times
\Bigl(\bigl(\tfrac{\text{Term2\_TTM}}{2 \times 360}\bigr) \times \text{OIS} \;+\; 1.0\Bigr).
\]</div>
</section>
<section id="implied-forward-rate">
<h3>4. Implied Forward Rate<a class="headerlink" href="#implied-forward-rate" title="Link to this heading">#</a></h3>
<p>From Hazelkorn et al. (2021), the <strong>raw</strong> implied forward rate (over (\tau_1) to (\tau_2)) is:</p>
<div class="math notranslate nohighlight">
\[
\text{implied\_forward\_raw} \;=\;
\frac{\text{Term2\_Futures\_Price} + \text{Div\_Sum2\_Comp}}{\text{Term1\_Futures\_Price} + \text{Div\_Sum1\_Comp}}
\;-\; 1.
\]</div>
<p>We <strong>annualize</strong> this raw rate by multiplying according to the difference in time-to-maturity ((\text{Term2_TTM} - \text{Term1_TTM})):</p>
<div class="math notranslate nohighlight">
\[
\text{cal\_rf}_{index} \;=\;
100 \times \text{implied\_forward\_raw} \;\times\;
\frac{360}{\text{Term2\_TTM} - \text{Term1\_TTM}}.
\]</div>
</section>
<section id="ois-implied-forward-rate">
<h3>5. OIS-Implied Forward Rate<a class="headerlink" href="#ois-implied-forward-rate" title="Link to this heading">#</a></h3>
<p>Similarly, we estimate how <strong>OIS</strong> would imply a forward rate between (\tau_1) and (\tau_2):</p>
<div class="math notranslate nohighlight">
\[
\text{ois\_fwd\_raw} \;=\;
\frac{1 + \text{OIS} \times \tfrac{\text{Term2\_TTM}}{360}}
     {1 + \text{OIS} \times \tfrac{\text{Term1\_TTM}}{360}}
\;-\; 1.
\]</div>
<p>We annualize it in the same manner:</p>
<div class="math notranslate nohighlight">
\[
\text{ois\_fwd}_{index} \;=\;
\text{ois\_fwd\_raw} \;\times\;
\frac{360}{\text{Term2\_TTM} - \text{Term1\_TTM}} \;\times\; 100.
\]</div>
</section>
<section id="spread-calculation">
<h3>6. Spread Calculation<a class="headerlink" href="#spread-calculation" title="Link to this heading">#</a></h3>
<p>We define the <strong>arbitrage spread</strong> in <strong>basis points</strong> (bps) as:</p>
<div class="math notranslate nohighlight">
\[
\text{spread}_{index} \;=\;
\bigl(\text{cal\_rf}_{index} - \text{ois\_fwd}_{index}\bigr) \times 100.
\]</div>
<p>A <strong>positive</strong> spread indicates the <strong>futures-implied forward rate</strong> is <strong>higher</strong> than the OIS-implied rate.</p>
</section>
<section id="outlier-filtering">
<h3>7. Outlier Filtering<a class="headerlink" href="#outlier-filtering" title="Link to this heading">#</a></h3>
<p>We apply a <strong>Barndorff–Nielsen filter</strong> on <code class="docutils literal notranslate"><span class="pre">spread_{index}</span></code> to flag outliers based on rolling median absolute deviation. These flagged values are set to <code class="docutils literal notranslate"><span class="pre">NaN</span></code> to remove spurious spikes or data errors.</p>
<hr class="docutils" />
<p><strong>Interpretation</strong></p>
<ul class="simple">
<li><p><strong>Spot-Futures Parity</strong> would suggest the forward rate extracted from futures = OIS rate, making the spread near zero.</p></li>
<li><p>A <strong>non-zero</strong> spread implies potential <strong>frictions</strong>, <strong>funding constraints</strong>, or <strong>margin requirements</strong> that might limit arbitrage.</p></li>
</ul>
<ol class="arabic simple">
<li><p><strong>Futures + Dividends</strong> yield an <strong>equity-implied forward rate</strong> over (\tau_1 \to \tau_2).</p></li>
<li><p><strong>OIS</strong> gives an alternative “risk-free” benchmark.</p></li>
<li><p>Comparing them highlights possible <strong>arbitrage</strong> or <strong>funding market</strong> dislocations.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 4. Comparing Forward Rates Across Indices</span>

<span class="k">def</span><span class="w"> </span><span class="nf">explore_cross_index_comparison</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare forward rates and spreads across different indices to identify patterns and relationships</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Exploring Cross-Index Forward Rate Analysis ===&quot;</span><span class="p">)</span>
    
    <span class="c1"># Process data for all indices</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">INDEX_CODES</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        
        <span class="n">fut_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">PROCESSED_DIR</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">_Calendar_spread.csv&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fut_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Missing futures file for </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">, skipping.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        
        <span class="c1"># Run the forward rate calculation</span>
        <span class="n">df_res</span> <span class="o">=</span> <span class="n">process_index_forward_rates</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">df_res</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_res</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid results to compare. Ending exploration.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="c1"># Create a unified DataFrame with spreads from all indices</span>
    <span class="c1"># First, find the union of all dates</span>
    <span class="n">all_dates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">all_dates</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    
    <span class="c1"># Sort dates</span>
    <span class="n">date_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_dates</span><span class="p">))</span>
    
    <span class="c1"># Create a DataFrame with all spreads</span>
    <span class="n">spreads_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">date_index</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">spread_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;spread_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1"># Forward fill to handle missing dates</span>
        <span class="n">spreads_df</span><span class="p">[</span><span class="n">spread_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">spread_col</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">date_index</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
    
    <span class="c1"># Show the head of the combined spreads</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Combined spreads data (first rows):&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">spreads_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
    
    <span class="c1"># Visualize combined spreads</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    
    <span class="n">colors</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;SPX&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;NDX&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;INDU&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">spread_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;spread_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">spreads_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
            <span class="n">spreads_df</span><span class="p">[</span><span class="n">spread_col</span><span class="p">],</span> 
            <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">),</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> Spread (bps)&quot;</span>
        <span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Implied Forward Spreads Across Indices (bps)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Spread (bps)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c1"># Calculate correlations between spreads</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">spreads_df</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Correlation matrix of spreads:&quot;</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">corr_matrix</span><span class="p">)</span>
        
        <span class="c1"># Visualize correlations</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">corr_matrix</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Correlation of Forward Rate Spreads Across Indices&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c1"># Z-score normalized spreads for comparison</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">spreads_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="c1"># Calculate z-scores for each spread</span>
        <span class="n">z_scores_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">spreads_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">spreads_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">z_scores_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">spreads_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">spreads_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">spreads_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="c1"># Visualize normalized spreads</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">spread_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;spread_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">z_scores_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
                <span class="n">z_scores_df</span><span class="p">[</span><span class="n">spread_col</span><span class="p">],</span> 
                <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">),</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> (Z-score)&quot;</span>
            <span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Z-Score Normalized Spreads Across Indices&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Z-Score&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    
    <span class="k">return</span> <span class="n">spreads_df</span>
<span class="n">cross_index_df</span> <span class="o">=</span> <span class="n">explore_cross_index_comparison</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== Exploring Cross-Index Forward Rate Analysis ===

Processing SPX...
[SPX] Starting forward rate computation
[SPX] Loaded futures shape: (3781, 14)
[SPX] Dropped 0 rows lacking a valid Date in futures.
[SPX] as-of merged OIS: from 3781 -&gt; 3781 rows (should be same).
[SPX] Building daily dividend table
Primary input file not found, switching to cached data
[SPX] daily dividends final shape: (3913, 2)
[SPX] Sample daily dividends:
        Date  Daily_Div
0 2010-01-01   0.000000
1 2010-01-04   0.058362
2 2010-01-05   0.001744
3 2010-01-06   0.497980
4 2010-01-07   0.061819
5 2010-01-08   0.000000
6 2010-01-11   0.000000
7 2010-01-12   0.000000
8 2010-01-13   0.113508
9 2010-01-14   0.021957
[SPX] as-of merged CumDiv at current date: from 3781 -&gt; 3781 rows.
[SPX] Sample merged rows with cumulative div:
        Date  Term1_Futures_Price  Term1_Volume  Term1_OpenInterest  \
0 2010-01-04              1128.75     1282633.0           2440458.0   
1 2010-01-05              1132.25     1368386.0           2402850.0   
2 2010-01-06              1133.00     1252015.0           2396493.0   
3 2010-01-07              1137.50     1553963.0           2406352.0   
4 2010-01-08              1141.50     1508175.0           2758348.0   
5 2010-01-11              1142.50     1444997.0           2427453.0   
6 2010-01-12              1134.00     2089364.0           2439036.0   
7 2010-01-13              1141.50     2110033.0           2475322.0   
8 2010-01-14              1145.25     1346436.0           2473392.0   
9 2010-01-15              1132.25     2031715.0           2454453.0   

  Term1_ContractSpec Term1_SettlementDate  Term1_TTM  Term2_Futures_Price  \
0             MAR 10           2010-03-19       74.0              1124.00   
1             MAR 10           2010-03-19       73.0              1127.50   
2             MAR 10           2010-03-19       72.0              1128.00   
3             MAR 10           2010-03-19       71.0              1132.50   
4             MAR 10           2010-03-19       70.0              1136.75   
5             MAR 10           2010-03-19       67.0              1137.50   
6             MAR 10           2010-03-19       66.0              1129.00   
7             MAR 10           2010-03-19       65.0              1136.75   
8             MAR 10           2010-03-19       64.0              1140.25   
9             MAR 10           2010-03-19       63.0              1127.50   

   Term2_Volume  Term2_OpenInterest Term2_ContractSpec Term2_SettlementDate  \
0        1641.0              3354.0             JUN 10           2010-06-18   
1         686.0              3432.0             JUN 10           2010-06-18   
2        1163.0              3713.0             JUN 10           2010-06-18   
3        1135.0              4154.0             JUN 10           2010-06-18   
4        1080.0             17466.0             JUN 10           2010-06-18   
5         419.0              4638.0             JUN 10           2010-06-18   
6         481.0              4765.0             JUN 10           2010-06-18   
7        1174.0              5389.0             JUN 10           2010-06-18   
8         333.0              5357.0             JUN 10           2010-06-18   
9        1432.0              5936.0             JUN 10           2010-06-18   

   Term2_TTM Index       OIS  CumDiv_current  
0      165.0   SPX  0.001620        0.058362  
1      164.0   SPX  0.001550        0.060106  
2      163.0   SPX  0.001460        0.558086  
3      162.0   SPX  0.001450        0.619905  
4      161.0   SPX  0.001430        0.619905  
5      158.0   SPX  0.001430        0.619905  
6      157.0   SPX  0.001415        0.619905  
7      156.0   SPX  0.001470        0.733413  
8      155.0   SPX  0.001430        0.755370  
9      154.0   SPX  0.001380        0.799620  
[SPX] as-of merged CumDiv for Term1: from 3781 -&gt; 3781 rows.
[SPX] as-of merged CumDiv for Term2: from 3781 -&gt; 3781 rows.
[SPX] Dropped 0 rows missing TTM or Futures_Price.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Barndorff-Nielsen filter: flagged 47 outliers in spread_SPX
[SPX] Setting 47 outliers to NaN for cal_SPX_rf &amp; spread_SPX
[SPX] Final forward rates shape: (3781, 29)
[SPX] Sample final rows:
            cal_SPX_rf  ois_fwd_SPX  spread_SPX
Date                                           
2024-12-24    3.778583     4.287412  -50.882869
2024-12-26    3.796641     4.277498  -48.085749
2024-12-27    3.741256     4.277624  -53.636841
2024-12-30    3.717731     4.275913  -55.818186
2024-12-31    3.698950     4.274017  -57.506667

Processing NDX...
[NDX] Starting forward rate computation
[NDX] Loaded futures shape: (3781, 14)
[NDX] Dropped 0 rows lacking a valid Date in futures.
[NDX] as-of merged OIS: from 3781 -&gt; 3781 rows (should be same).
[NDX] Building daily dividend table
Primary input file not found, switching to cached data
[NDX] daily dividends final shape: (3913, 2)
[NDX] Sample daily dividends:
        Date  Daily_Div
0 2010-01-01   0.000000
1 2010-01-04   0.148515
2 2010-01-05   0.000000
3 2010-01-06   0.000000
4 2010-01-07   0.000000
5 2010-01-08   0.000000
6 2010-01-11   0.000000
7 2010-01-12   0.000000
8 2010-01-13   0.000000
9 2010-01-14   0.113752
[NDX] as-of merged CumDiv at current date: from 3781 -&gt; 3781 rows.
[NDX] Sample merged rows with cumulative div:
        Date  Term1_Futures_Price  Term1_Volume  Term1_OpenInterest  \
0 2010-01-04              1886.75      204140.0            314877.0   
1 2010-01-05              1885.25      207245.0            309080.0   
2 2010-01-06              1878.50      259627.0            310532.0   
3 2010-01-07              1877.50      239907.0            317226.0   
4 2010-01-08              1890.00      267314.0            379994.0   
5 2010-01-11              1883.50      243454.0            314557.0   
6 2010-01-12              1865.50      326600.0            306114.0   
7 2010-01-13              1882.50      312998.0            331168.0   
8 2010-01-14              1888.25      204465.0            324274.0   
9 2010-01-15              1862.25      343007.0            320266.0   

  Term1_ContractSpec Term1_SettlementDate  Term1_TTM  Term2_Futures_Price  \
0             MAR 10           2010-03-19       74.0              1884.75   
1             MAR 10           2010-03-19       73.0              1883.00   
2             MAR 10           2010-03-19       72.0              1876.50   
3             MAR 10           2010-03-19       71.0              1875.00   
4             MAR 10           2010-03-19       70.0              1887.25   
5             MAR 10           2010-03-19       67.0              1880.75   
6             MAR 10           2010-03-19       66.0              1862.75   
7             MAR 10           2010-03-19       65.0              1879.75   
8             MAR 10           2010-03-19       64.0              1885.50   
9             MAR 10           2010-03-19       63.0              1859.75   

   Term2_Volume  Term2_OpenInterest Term2_ContractSpec Term2_SettlementDate  \
0          33.0               671.0             JUN 10           2010-06-18   
1          74.0               651.0             JUN 10           2010-06-18   
2          33.0               665.0             JUN 10           2010-06-18   
3          47.0               672.0             JUN 10           2010-06-18   
4        1001.0              6163.0             JUN 10           2010-06-18   
5         288.0               898.0             JUN 10           2010-06-18   
6         311.0              1077.0             JUN 10           2010-06-18   
7         710.0              1699.0             JUN 10           2010-06-18   
8         784.0              2401.0             JUN 10           2010-06-18   
9         272.0              2533.0             JUN 10           2010-06-18   

   Term2_TTM Index       OIS  CumDiv_current  
0      165.0   NDX  0.001620        0.148515  
1      164.0   NDX  0.001550        0.148515  
2      163.0   NDX  0.001460        0.148515  
3      162.0   NDX  0.001450        0.148515  
4      161.0   NDX  0.001430        0.148515  
5      158.0   NDX  0.001430        0.148515  
6      157.0   NDX  0.001415        0.148515  
7      156.0   NDX  0.001470        0.148515  
8      155.0   NDX  0.001430        0.262267  
9      154.0   NDX  0.001380        0.262267  
[NDX] as-of merged CumDiv for Term1: from 3781 -&gt; 3781 rows.
[NDX] as-of merged CumDiv for Term2: from 3781 -&gt; 3781 rows.
[NDX] Dropped 0 rows missing TTM or Futures_Price.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Barndorff-Nielsen filter: flagged 48 outliers in spread_NDX
[NDX] Setting 48 outliers to NaN for cal_NDX_rf &amp; spread_NDX
[NDX] Final forward rates shape: (3781, 29)
[NDX] Sample final rows:
            cal_NDX_rf  ois_fwd_NDX  spread_NDX
Date                                           
2024-12-24    4.341428     4.287412    5.401572
2024-12-26    4.426357     4.277498   14.885916
2024-12-27    4.384662     4.277624   10.703781
2024-12-30    4.322400     4.275913    4.648708
2024-12-31    4.323851     4.274017    4.983391

Processing INDU...
[INDU] Starting forward rate computation
[INDU] Loaded futures shape: (3780, 14)
[INDU] Dropped 0 rows lacking a valid Date in futures.
[INDU] as-of merged OIS: from 3780 -&gt; 3780 rows (should be same).
[INDU] Building daily dividend table
Primary input file not found, switching to cached data
[INDU] daily dividends final shape: (3913, 2)
[INDU] Sample daily dividends:
        Date  Daily_Div
0 2010-01-01   0.000000
1 2010-01-04   0.377875
2 2010-01-05   0.000000
3 2010-01-06   6.763957
4 2010-01-07   1.360349
5 2010-01-08   0.000000
6 2010-01-11   0.000000
7 2010-01-12   0.000000
8 2010-01-13   0.000000
9 2010-01-14   0.000000
[INDU] as-of merged CumDiv at current date: from 3780 -&gt; 3780 rows.
[INDU] Sample merged rows with cumulative div:
        Date  Term1_Futures_Price  Term1_Volume  Term1_OpenInterest  \
0 2010-01-04              10519.0       93770.0             69420.0   
1 2010-01-05              10515.0       93287.0             65749.0   
2 2010-01-06              10516.0       97172.0             63888.0   
3 2010-01-07              10545.0      112280.0             67401.0   
4 2010-01-08              10566.0       79925.0             61714.0   
5 2010-01-11              10604.0       93891.0             63318.0   
6 2010-01-12              10588.0      126885.0             62710.0   
7 2010-01-13              10628.0      113576.0             63479.0   
8 2010-01-14              10663.0       80520.0             64500.0   
9 2010-01-15              10563.0      140591.0             66826.0   

  Term1_ContractSpec Term1_SettlementDate  Term1_TTM  Term2_Futures_Price  \
0             MAR 10           2010-03-19       74.0              10459.0   
1             MAR 10           2010-03-19       73.0              10455.0   
2             MAR 10           2010-03-19       72.0              10455.0   
3             MAR 10           2010-03-19       71.0              10484.0   
4             MAR 10           2010-03-19       70.0              10505.0   
5             MAR 10           2010-03-19       67.0              10542.0   
6             MAR 10           2010-03-19       66.0              10527.0   
7             MAR 10           2010-03-19       65.0              10566.0   
8             MAR 10           2010-03-19       64.0              10601.0   
9             MAR 10           2010-03-19       63.0              10501.0   

   Term2_Volume  Term2_OpenInterest Term2_ContractSpec Term2_SettlementDate  \
0         100.0               175.0             JUN 10           2010-06-18   
1          26.0               173.0             JUN 10           2010-06-18   
2         157.0               193.0             JUN 10           2010-06-18   
3          34.0               180.0             JUN 10           2010-06-18   
4         146.0               531.0             JUN 10           2010-06-18   
5          45.0               230.0             JUN 10           2010-06-18   
6          55.0               234.0             JUN 10           2010-06-18   
7          21.0               208.0             JUN 10           2010-06-18   
8          11.0               206.0             JUN 10           2010-06-18   
9          80.0               221.0             JUN 10           2010-06-18   

   Term2_TTM Index       OIS  CumDiv_current  
0      165.0  INDU  0.001620        0.377875  
1      164.0  INDU  0.001550        0.377875  
2      163.0  INDU  0.001460        7.141832  
3      162.0  INDU  0.001450        8.502181  
4      161.0  INDU  0.001430        8.502181  
5      158.0  INDU  0.001430        8.502181  
6      157.0  INDU  0.001415        8.502181  
7      156.0  INDU  0.001470        8.502181  
8      155.0  INDU  0.001430        8.502181  
9      154.0  INDU  0.001380       11.676328  
[INDU] as-of merged CumDiv for Term1: from 3780 -&gt; 3780 rows.
[INDU] as-of merged CumDiv for Term2: from 3780 -&gt; 3780 rows.
[INDU] Dropped 0 rows missing TTM or Futures_Price.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Barndorff-Nielsen filter: flagged 43 outliers in spread_INDU
[INDU] Setting 43 outliers to NaN for cal_INDU_rf &amp; spread_INDU
[INDU] Final forward rates shape: (3780, 29)
[INDU] Sample final rows:
            cal_INDU_rf  ois_fwd_INDU  spread_INDU
Date                                              
2024-12-24     3.525951      4.287412   -76.146147
2024-12-26     3.485142      4.277498   -79.235563
2024-12-27     3.459165      4.277624   -81.845864
2024-12-30     3.446690      4.275913   -82.922307
2024-12-31     3.377212      4.274017   -89.680496

Combined spreads data (first rows):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>spread_SPX</th>
      <th>spread_NDX</th>
      <th>spread_INDU</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2010-01-04</th>
      <td>11.572066</td>
      <td>22.661276</td>
      <td>25.302054</td>
    </tr>
    <tr>
      <th>2010-01-05</th>
      <td>12.181110</td>
      <td>18.151200</td>
      <td>26.010192</td>
    </tr>
    <tr>
      <th>2010-01-06</th>
      <td>4.369103</td>
      <td>24.426083</td>
      <td>23.178006</td>
    </tr>
    <tr>
      <th>2010-01-07</th>
      <td>4.393865</td>
      <td>14.026219</td>
      <td>23.177080</td>
    </tr>
    <tr>
      <th>2010-01-08</th>
      <td>13.157910</td>
      <td>8.811714</td>
      <td>23.300181</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/00d42bb0e5a4d67a44977a5543c1311d0f76a73daba6d809c81537e5a8a51272.png" src="../_images/00d42bb0e5a4d67a44977a5543c1311d0f76a73daba6d809c81537e5a8a51272.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Correlation matrix of spreads:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>spread_SPX</th>
      <th>spread_NDX</th>
      <th>spread_INDU</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>spread_SPX</th>
      <td>1.000000</td>
      <td>0.842434</td>
      <td>0.894422</td>
    </tr>
    <tr>
      <th>spread_NDX</th>
      <td>0.842434</td>
      <td>1.000000</td>
      <td>0.745491</td>
    </tr>
    <tr>
      <th>spread_INDU</th>
      <td>0.894422</td>
      <td>0.745491</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/c5fbbd56ae9a908d44e3ca125da72d6f3a7fa2759b9919111d14ccbe7a3991d6.png" src="../_images/c5fbbd56ae9a908d44e3ca125da72d6f3a7fa2759b9919111d14ccbe7a3991d6.png" />
<img alt="../_images/95097e073f4a59e571eb7b84d972937a5e9ed4fc4bd55aa585274f409d4eed3c.png" src="../_images/95097e073f4a59e571eb7b84d972937a5e9ed4fc4bd55aa585274f409d4eed3c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 5. Exploring the Economic Significance of Forward Rate Spreads</span>

<span class="k">def</span><span class="w"> </span><span class="nf">explore_economic_significance</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze the economic significance of forward rate spreads</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Exploring Economic Significance of Forward Rate Spreads ===&quot;</span><span class="p">)</span>
    
    <span class="c1"># Process data for SPX (as an example)</span>
    <span class="n">index_code</span> <span class="o">=</span> <span class="s2">&quot;SPX&quot;</span>
    <span class="n">fut_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">PROCESSED_DIR</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">_Calendar_spread.csv&quot;</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fut_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing futures file for </span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">. Cannot proceed with exploration.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="c1"># Run the forward rate calculation</span>
    <span class="n">df_res</span> <span class="o">=</span> <span class="n">process_index_forward_rates</span><span class="p">(</span><span class="n">index_code</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">df_res</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">df_res</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid results. Ending exploration.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="c1"># Set the spread column</span>
    <span class="n">spread_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;spread_</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">&quot;</span>
    
    
    <span class="c1"># Calculate the percentage of time the spread is positive vs negative</span>
    <span class="n">positive_spread</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_res</span><span class="p">[</span><span class="n">spread_col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">negative_spread</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_res</span><span class="p">[</span><span class="n">spread_col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Spread direction summary:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Positive spread: </span><span class="si">{</span><span class="n">positive_spread</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% of the time&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Negative spread: </span><span class="si">{</span><span class="n">negative_spread</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% of the time&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Zero or missing: </span><span class="si">{</span><span class="mi">100</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">positive_spread</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">negative_spread</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% of the time&quot;</span><span class="p">)</span>
    
    <span class="c1"># Visualize the distribution of spreads</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">df_res</span><span class="p">[</span><span class="n">spread_col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">df_res</span><span class="p">[</span><span class="n">spread_col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> 
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mean: </span><span class="si">{</span><span class="n">df_res</span><span class="p">[</span><span class="n">spread_col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> bps&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2"> Forward Rate Spread Distribution (bps)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Spread (bps)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c1"># Create a time plot with positive/negative highlighting</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    
    <span class="c1"># Plot the spread</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_res</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_res</span><span class="p">[</span><span class="n">spread_col</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Highlight positive and negative regions</span>
    <span class="n">positive_mask</span> <span class="o">=</span> <span class="n">df_res</span><span class="p">[</span><span class="n">spread_col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">negative_mask</span> <span class="o">=</span> <span class="n">df_res</span><span class="p">[</span><span class="n">spread_col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_res</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">df_res</span><span class="p">[</span><span class="n">spread_col</span><span class="p">],</span> <span class="n">where</span><span class="o">=</span><span class="n">positive_mask</span><span class="p">,</span> 
                     <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Positive Spread&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_res</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">df_res</span><span class="p">[</span><span class="n">spread_col</span><span class="p">],</span> <span class="n">where</span><span class="o">=</span><span class="n">negative_mask</span><span class="p">,</span> 
                     <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Negative Spread&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2"> Forward Rate Spread Over Time (bps)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Spread (bps)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c1"># Calculate persistence - how long spreads stay positive or negative</span>
    <span class="n">df_res</span><span class="p">[</span><span class="s1">&#39;spread_sign&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">df_res</span><span class="p">[</span><span class="n">spread_col</span><span class="p">])</span>
    <span class="n">df_res</span><span class="p">[</span><span class="s1">&#39;regime_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_res</span><span class="p">[</span><span class="s1">&#39;spread_sign&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">df_res</span><span class="p">[</span><span class="s1">&#39;regime_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_res</span><span class="p">[</span><span class="s1">&#39;regime_change&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    
    <span class="c1"># Get regime lengths</span>
    <span class="n">regime_lengths</span> <span class="o">=</span> <span class="n">df_res</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;regime_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    
    <span class="c1"># Separate positive and negative regimes</span>
    <span class="n">regime_signs</span> <span class="o">=</span> <span class="n">df_res</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;regime_id&#39;</span><span class="p">)[</span><span class="s1">&#39;spread_sign&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    
    <span class="n">positive_lengths</span> <span class="o">=</span> <span class="n">regime_lengths</span><span class="p">[</span><span class="n">regime_signs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">negative_lengths</span> <span class="o">=</span> <span class="n">regime_lengths</span><span class="p">[</span><span class="n">regime_signs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Regime persistence:&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">positive_lengths</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Positive spread regimes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">positive_lengths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Average positive regime duration: </span><span class="si">{</span><span class="n">positive_lengths</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> days&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Longest positive regime: </span><span class="si">{</span><span class="n">positive_lengths</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2"> days&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">negative_lengths</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Negative spread regimes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">negative_lengths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Average negative regime duration: </span><span class="si">{</span><span class="n">negative_lengths</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> days&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Longest negative regime: </span><span class="si">{</span><span class="n">negative_lengths</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2"> days&quot;</span><span class="p">)</span>
    
    <span class="c1"># Visualize regime persistence with a boxplot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">positive_lengths</span><span class="p">,</span> <span class="n">negative_lengths</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Positive Spread&#39;</span><span class="p">,</span> <span class="s1">&#39;Negative Spread&#39;</span><span class="p">]</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">patch_artist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">),</span>
                <span class="n">whiskerprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">),</span>
                <span class="n">capprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">),</span>
                <span class="n">medianprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">))</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2"> Forward Rate Spread Regime Persistence&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Duration (Days)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    
    <span class="k">return</span> <span class="n">df_res</span>

<span class="c1"># Run the exploration</span>
<span class="n">economic_df</span> <span class="o">=</span> <span class="n">explore_economic_significance</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== Exploring Economic Significance of Forward Rate Spreads ===
[SPX] Starting forward rate computation
[SPX] Loaded futures shape: (3781, 14)
[SPX] Dropped 0 rows lacking a valid Date in futures.
[SPX] as-of merged OIS: from 3781 -&gt; 3781 rows (should be same).
[SPX] Building daily dividend table
Primary input file not found, switching to cached data
[SPX] daily dividends final shape: (3913, 2)
[SPX] Sample daily dividends:
        Date  Daily_Div
0 2010-01-01   0.000000
1 2010-01-04   0.058362
2 2010-01-05   0.001744
3 2010-01-06   0.497980
4 2010-01-07   0.061819
5 2010-01-08   0.000000
6 2010-01-11   0.000000
7 2010-01-12   0.000000
8 2010-01-13   0.113508
9 2010-01-14   0.021957
[SPX] as-of merged CumDiv at current date: from 3781 -&gt; 3781 rows.
[SPX] Sample merged rows with cumulative div:
        Date  Term1_Futures_Price  Term1_Volume  Term1_OpenInterest  \
0 2010-01-04              1128.75     1282633.0           2440458.0   
1 2010-01-05              1132.25     1368386.0           2402850.0   
2 2010-01-06              1133.00     1252015.0           2396493.0   
3 2010-01-07              1137.50     1553963.0           2406352.0   
4 2010-01-08              1141.50     1508175.0           2758348.0   
5 2010-01-11              1142.50     1444997.0           2427453.0   
6 2010-01-12              1134.00     2089364.0           2439036.0   
7 2010-01-13              1141.50     2110033.0           2475322.0   
8 2010-01-14              1145.25     1346436.0           2473392.0   
9 2010-01-15              1132.25     2031715.0           2454453.0   

  Term1_ContractSpec Term1_SettlementDate  Term1_TTM  Term2_Futures_Price  \
0             MAR 10           2010-03-19       74.0              1124.00   
1             MAR 10           2010-03-19       73.0              1127.50   
2             MAR 10           2010-03-19       72.0              1128.00   
3             MAR 10           2010-03-19       71.0              1132.50   
4             MAR 10           2010-03-19       70.0              1136.75   
5             MAR 10           2010-03-19       67.0              1137.50   
6             MAR 10           2010-03-19       66.0              1129.00   
7             MAR 10           2010-03-19       65.0              1136.75   
8             MAR 10           2010-03-19       64.0              1140.25   
9             MAR 10           2010-03-19       63.0              1127.50   

   Term2_Volume  Term2_OpenInterest Term2_ContractSpec Term2_SettlementDate  \
0        1641.0              3354.0             JUN 10           2010-06-18   
1         686.0              3432.0             JUN 10           2010-06-18   
2        1163.0              3713.0             JUN 10           2010-06-18   
3        1135.0              4154.0             JUN 10           2010-06-18   
4        1080.0             17466.0             JUN 10           2010-06-18   
5         419.0              4638.0             JUN 10           2010-06-18   
6         481.0              4765.0             JUN 10           2010-06-18   
7        1174.0              5389.0             JUN 10           2010-06-18   
8         333.0              5357.0             JUN 10           2010-06-18   
9        1432.0              5936.0             JUN 10           2010-06-18   

   Term2_TTM Index       OIS  CumDiv_current  
0      165.0   SPX  0.001620        0.058362  
1      164.0   SPX  0.001550        0.060106  
2      163.0   SPX  0.001460        0.558086  
3      162.0   SPX  0.001450        0.619905  
4      161.0   SPX  0.001430        0.619905  
5      158.0   SPX  0.001430        0.619905  
6      157.0   SPX  0.001415        0.619905  
7      156.0   SPX  0.001470        0.733413  
8      155.0   SPX  0.001430        0.755370  
9      154.0   SPX  0.001380        0.799620  
[SPX] as-of merged CumDiv for Term1: from 3781 -&gt; 3781 rows.
[SPX] as-of merged CumDiv for Term2: from 3781 -&gt; 3781 rows.
[SPX] Dropped 0 rows missing TTM or Futures_Price.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Barndorff-Nielsen filter: flagged 47 outliers in spread_SPX
[SPX] Setting 47 outliers to NaN for cal_SPX_rf &amp; spread_SPX
[SPX] Final forward rates shape: (3781, 29)
[SPX] Sample final rows:
            cal_SPX_rf  ois_fwd_SPX  spread_SPX
Date                                           
2024-12-24    3.778583     4.287412  -50.882869
2024-12-26    3.796641     4.277498  -48.085749
2024-12-27    3.741256     4.277624  -53.636841
2024-12-30    3.717731     4.275913  -55.818186
2024-12-31    3.698950     4.274017  -57.506667

Spread direction summary:
  Positive spread: 96.9% of the time
  Negative spread: 1.8% of the time
  Zero or missing: 1.2% of the time
</pre></div>
</div>
<img alt="../_images/3337974b0aaf7227a0314f6fbb211dc0b0bf0ae77a64472ccfe6b615e4aad5b9.png" src="../_images/3337974b0aaf7227a0314f6fbb211dc0b0bf0ae77a64472ccfe6b615e4aad5b9.png" />
<img alt="../_images/cecb55377fe20075c8cf1be9788491f77ad3989fb759eb6505e7a26b771b81d4.png" src="../_images/cecb55377fe20075c8cf1be9788491f77ad3989fb759eb6505e7a26b771b81d4.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Regime persistence:
  Positive spread regimes: 59
  Average positive regime duration: 62.1 days
  Longest positive regime: 191 days
  Negative spread regimes: 17
  Average negative regime duration: 4.1 days
  Longest negative regime: 37 days
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\Andik\AppData\Local\Temp\ipykernel_8\1733434661.py:106: MatplotlibDeprecationWarning: The &#39;labels&#39; parameter of boxplot() has been renamed &#39;tick_labels&#39; since Matplotlib 3.9; support for the old name will be dropped in 3.11.
  plt.boxplot(data, labels=labels, patch_artist=True,
</pre></div>
</div>
<img alt="../_images/a6925031f43f465adaa14c6bd52d388f359d5a31b2d480e3b7e032b0790d4dee.png" src="../_images/a6925031f43f465adaa14c6bd52d388f359d5a31b2d480e3b7e032b0790d4dee.png" />
</div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="theoretical-understanding-of-implied-forward-rate-calculation">
<h1>Theoretical Understanding of Implied Forward Rate Calculation<a class="headerlink" href="#theoretical-understanding-of-implied-forward-rate-calculation" title="Link to this heading">#</a></h1>
<section id="id1">
<h2>1. Understanding Daily Dividends<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<p>The daily dividend processing is a crucial first step in forward rate calculation. It involves:</p>
<ul class="simple">
<li><p><strong>Data Source</strong>: Extracting dividend data from Bloomberg historical data</p></li>
<li><p><strong>Processing Steps</strong>: Converting dates, handling missing values, and calculating cumulative dividends</p></li>
<li><p><strong>Key Insight</strong>: Dividends accumulate over time and impact future values of the index</p></li>
<li><p><strong>Seasonality</strong>: There are often patterns in dividend distributions throughout the year</p></li>
<li><p><strong>Importance</strong>: Accurate dividend projections are essential for proper forward rate calculation</p></li>
</ul>
<p>Understanding how dividends accumulate between the current date and settlement dates is critical. The spread between nearby and farther-term futures contracts must account for these dividend payments.</p>
</section>
<section id="barndorff-nielsen-outlier-filter">
<h2>2. Barndorff-Nielsen Outlier Filter<a class="headerlink" href="#barndorff-nielsen-outlier-filter" title="Link to this heading">#</a></h2>
<p>The Barndorff-Nielsen filter identifies and removes statistical outliers in time series data:</p>
<ul class="simple">
<li><p><strong>Core Components</strong>:</p>
<ul>
<li><p>Rolling median calculation (robust central tendency measure)</p></li>
<li><p>Absolute deviation from the median</p></li>
<li><p>Mean absolute deviation (MAD) as a scale measure</p></li>
<li><p>Standardized deviation (absolute deviation / MAD)</p></li>
<li><p>Threshold comparison to identify outliers</p></li>
</ul>
</li>
<li><p><strong>Key Advantages</strong>:</p>
<ul>
<li><p>Insensitive to extreme values (unlike mean/standard deviation)</p></li>
<li><p>Adapts to local characteristics of the time series</p></li>
<li><p>Preserves legitimate signal changes while removing anomalies</p></li>
</ul>
</li>
<li><p><strong>Application to Forward Rates</strong>:</p>
<ul>
<li><p>Removes data errors or market dislocations that would distort analysis</p></li>
<li><p>Helps identify true arbitrage opportunities vs. data anomalies</p></li>
</ul>
</li>
</ul>
</section>
<section id="forward-rate-calculation-process">
<h2>3. Forward Rate Calculation Process<a class="headerlink" href="#forward-rate-calculation-process" title="Link to this heading">#</a></h2>
<p>The forward rate calculation is based on the cost-of-carry model with dividends:</p>
<ul class="simple">
<li><p><strong>Step 1: Data Merging</strong></p>
<ul>
<li><p>Calendar spread data (near/next futures prices and settlement dates)</p></li>
<li><p>OIS rates (risk-free benchmark)</p></li>
<li><p>Daily dividends (accumulation between current and settlement dates)</p></li>
</ul>
</li>
<li><p><strong>Step 2: Dividend Sum Calculation</strong></p>
<ul>
<li><p>Calculate expected dividends between observation date and both settlement dates</p></li>
<li><p>Apply half-interval compounding using the OIS rate to account for time value</p></li>
</ul>
</li>
<li><p><strong>Step 3: Implied Forward Rate Calculation</strong></p>
<ul>
<li><p>Calculate raw implied forward rate from futures prices and compounded dividends</p></li>
<li><p>Annualize the rate by dividing by the time difference and multiplying by 360</p></li>
</ul>
</li>
<li><p><strong>Step 4: OIS-implied Forward Rate</strong></p>
<ul>
<li><p>Calculate the theoretical forward rate based solely on OIS rates</p></li>
<li><p>This represents the risk-free expectation of future rates</p></li>
</ul>
</li>
<li><p><strong>Step 5: Spread Calculation</strong></p>
<ul>
<li><p>The difference between implied and OIS forward rates represents potential arbitrage</p></li>
<li><p>Expressed in basis points for easier interpretation</p></li>
</ul>
</li>
</ul>
<p>The theoretical foundation is that under no-arbitrage conditions, the spread should be zero. Deviations represent market inefficiencies or risk premia.</p>
</section>
<section id="cross-index-analysis">
<h2>4. Cross-Index Analysis<a class="headerlink" href="#cross-index-analysis" title="Link to this heading">#</a></h2>
<p>Comparing forward rate spreads across different indices offers deeper insights:</p>
<ul class="simple">
<li><p><strong>Correlation Analysis</strong>:</p>
<ul>
<li><p>High correlation suggests common market drivers</p></li>
<li><p>Low correlation indicates index-specific factors</p></li>
</ul>
</li>
<li><p><strong>Z-Score Normalization</strong>:</p>
<ul>
<li><p>Allows comparison of spreads with different volatility characteristics</p></li>
<li><p>Highlights periods of abnormal behavior across indices</p></li>
</ul>
</li>
<li><p><strong>Rolling Correlation</strong>:</p>
<ul>
<li><p>Shows how relationships between indices evolve over time</p></li>
<li><p>Can identify regime changes in market integration</p></li>
</ul>
</li>
</ul>
<p>Differences in spread behavior across indices may reveal:</p>
<ul class="simple">
<li><p>Different dividend expectations</p></li>
<li><p>Index-specific liquidity constraints</p></li>
<li><p>Varying market microstructure</p></li>
</ul>
</section>
<section id="theoretical-framework">
<h2>5. Theoretical Framework<a class="headerlink" href="#theoretical-framework" title="Link to this heading">#</a></h2>
<p>The implied forward rate calculation is grounded in financial theory:</p>
<ul class="simple">
<li><p><strong>Cost-of-Carry Model</strong>:</p>
<ul>
<li><p>F(t,T) = S(t) × e^((r-d)(T-t))</p></li>
<li><p>Where F is futures price, S is spot price, r is risk-free rate, d is dividend yield</p></li>
</ul>
</li>
<li><p><strong>No-Arbitrage Principle</strong>:</p>
<ul>
<li><p>In perfectly efficient markets with no frictions, the implied forward rate should equal the OIS forward rate</p></li>
<li><p>Deviations create arbitrage opportunities</p></li>
</ul>
</li>
<li><p><strong>Yield Curve Theory</strong>:</p>
<ul>
<li><p>Forward rates contain information about market expectations of future interest rates</p></li>
<li><p>Term structure shapes influence the relationship between near and far-term rates</p></li>
</ul>
</li>
<li><p><strong>Funding Liquidity</strong>:</p>
<ul>
<li><p>Constraints in funding can create persistent deviations from theoretical values</p></li>
<li><p>The spread can be viewed as a measure of funding conditions</p></li>
</ul>
</li>
<li><p><strong>Dividend Uncertainty</strong>:</p>
<ul>
<li><p>Differences between expected and actual dividends affect the spread</p></li>
<li><p>Market pricing may include a risk premium for dividend uncertainty</p></li>
</ul>
</li>
</ul>
</section>
</section>

<div class="section ablog__blog_comments">
   
</div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="02_Futures_Data_Processing.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Futures Data Processing Walkthrough</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Equity Spot-Futures Arbitrage: Implied Forward Rate Computation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#theoretical-background">Theoretical Background</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-the-functions-visual-understanding-of-implied-forward-rate-calculation">Exploring the Functions: Visual Understanding of Implied Forward Rate Calculation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-daily-dividends">Understanding Daily Dividends</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-barndorff-nielsen-outlier-filter">Understanding Barndorff-Nielsen Outlier Filter</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-forward-rate-calculation-process">Understanding the Forward Rate Calculation Process</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preparation-merging">1. Data Preparation &amp; Merging</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dividend-sums">2. Dividend Sums</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dividend-compounding">3. Dividend Compounding</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implied-forward-rate">4. Implied Forward Rate</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ois-implied-forward-rate">5. OIS-Implied Forward Rate</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spread-calculation">6. Spread Calculation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-filtering">7. Outlier Filtering</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#theoretical-understanding-of-implied-forward-rate-calculation">Theoretical Understanding of Implied Forward Rate Calculation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">1. Understanding Daily Dividends</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#barndorff-nielsen-outlier-filter">2. Barndorff-Nielsen Outlier Filter</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#forward-rate-calculation-process">3. Forward Rate Calculation Process</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-index-analysis">4. Cross-Index Analysis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#theoretical-framework">5. Theoretical Framework</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andy Andikko & Harrison Zhang
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025, Andy Andikko &amp; Harrison Zhang.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>