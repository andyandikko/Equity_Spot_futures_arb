
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Futures Data Processing Walkthrough &#8212; Equity Spot Futures Arbitrage Replication</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=b9472d72"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/02_Futures_Data_Processing';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Equity Spot-Futures Arbitrage: Implied Forward Rate Computation" href="03_Spread_Calculations.html" />
    <link rel="prev" title="OIS Rate Data Processing Walkthrough" href="01_OIS_Data_Processing.html" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>   
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Equity Spot Futures Arbitrage Replication - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Equity Spot Futures Arbitrage Replication - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    Equity Spot Futures Arbitrage
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Notebooks ðŸ“–</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01_OIS_Data_Processing.html">OIS Rate Data Processing Walkthrough</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Futures Data Processing Walkthrough</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_Spread_Calculations.html">Equity Spot-Futures Arbitrage: Implied Forward Rate Computation</a></li>


</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/jmbejara/blank_project" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/jmbejara/blank_project/issues/new?title=Issue%20on%20page%20%2Fnotebooks/02_Futures_Data_Processing.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/02_Futures_Data_Processing.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Futures Data Processing Walkthrough</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#project-context-equity-spot-futures-arbitrage">Project Context: Equity Spot-Futures Arbitrage</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-libraries">Load Libraries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-utility-functions">Define Utility Functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-bloomberg-data">Load Bloomberg Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-index-futures-mapping">Define Index Futures Mapping</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#process-futures-data">Process Futures Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#process-all-indices">Process All Indices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analyze-contract-roll-patterns">Analyze Contract Roll Patterns</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-calendar-spreads">Create Calendar Spreads</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-and-analyze-calendar-spreads">Create and Analyze Calendar Spreads</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-quality-checks">Data Quality Checks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#futures-price-visualization">Futures Price Visualization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#integration-with-forward-rate-calculations">Integration with Forward Rate Calculations</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                   <section class="tex2jax_ignore mathjax_ignore" id="futures-data-processing-walkthrough">
<h1>Futures Data Processing Walkthrough<a class="headerlink" href="#futures-data-processing-walkthrough" title="Link to this heading">#</a></h1>
<p>This notebook demonstrates the data processing pipeline for equity index futures data, which is a critical component of our equity spot-futures arbitrage analysis project.</p>
<section id="project-context-equity-spot-futures-arbitrage">
<h2>Project Context: Equity Spot-Futures Arbitrage<a class="headerlink" href="#project-context-equity-spot-futures-arbitrage" title="Link to this heading">#</a></h2>
<p>Our project analyzes arbitrage opportunities between equity spot and futures markets, focusing on three major indices:</p>
<ul class="simple">
<li><p>S&amp;P 500 (SPX with ES futures)</p></li>
<li><p>Nasdaq 100 (NDX with NQ futures)</p></li>
<li><p>Dow Jones Industrial Average (INDU with DM futures)</p></li>
</ul>
<p>To calculate implied forward rates for arbitrage analysis, we need properly processed futures data with accurate settlement dates and time-to-maturity calculations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">calendar</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">&#39;whitegrid&#39;</span><span class="p">)</span>

<span class="c1"># Add the src directory to the path to import our settings</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;./src&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Successfully imported config from settings module&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to import config. Make sure your working directory is set correctly.&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">config</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="n">config_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;DATA_DIR&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./_data&quot;</span><span class="p">),</span>
            <span class="s2">&quot;TEMP_DIR&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./_data/temp&quot;</span><span class="p">),</span>
            <span class="s2">&quot;INPUT_DIR&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./_data/input&quot;</span><span class="p">),</span>
            <span class="s2">&quot;PROCESSED_DIR&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./_data/processed&quot;</span><span class="p">),</span>
            <span class="s2">&quot;MANUAL_DATA_DIR&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./data_manual&quot;</span><span class="p">),</span>
            <span class="s2">&quot;OUTPUT_DIR&quot;</span><span class="p">:</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./_output&quot;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Successfully imported config from settings module
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-libraries">
<h2>Load Libraries<a class="headerlink" href="#load-libraries" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load configuration paths</span>
<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s2">&quot;DATA_DIR&quot;</span><span class="p">)</span>
<span class="n">TEMP_DIR</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s2">&quot;TEMP_DIR&quot;</span><span class="p">)</span>
<span class="n">INPUT_DIR</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s2">&quot;INPUT_DIR&quot;</span><span class="p">)</span>
<span class="n">PROCESSED_DIR</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s2">&quot;PROCESSED_DIR&quot;</span><span class="p">)</span>
<span class="n">DATA_MANUAL</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s2">&quot;MANUAL_DATA_DIR&quot;</span><span class="p">)</span>
<span class="n">OUTPUT_DIR</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s2">&quot;OUTPUT_DIR&quot;</span><span class="p">)</span>

<span class="c1"># Create directories if they don&#39;t exist</span>
<span class="k">for</span> <span class="n">dir_path</span> <span class="ow">in</span> <span class="p">[</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">TEMP_DIR</span><span class="p">,</span> <span class="n">INPUT_DIR</span><span class="p">,</span> <span class="n">PROCESSED_DIR</span><span class="p">,</span> <span class="n">DATA_MANUAL</span><span class="p">]:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Set up logging</span>
<span class="n">log_file</span> <span class="o">=</span> <span class="n">TEMP_DIR</span> <span class="o">/</span> <span class="s1">&#39;futures_processing_notebook.log&#39;</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">handlers</span><span class="o">=</span><span class="p">[</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_file</span><span class="p">),</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Logging configured successfully&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Log file will be saved to: </span><span class="si">{</span><span class="n">log_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:26,143 - INFO - Logging configured successfully
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:26,144 - INFO - Log file will be saved to: C:\Users\Andik\OneDrive\Desktop\Chicago\Full_stack_QF\Equity_Spot_futures_arb\_output\temp\futures_processing_notebook.log
</pre></div>
</div>
</div>
</div>
</section>
<section id="define-utility-functions">
<h2>Define Utility Functions<a class="headerlink" href="#define-utility-functions" title="Link to this heading">#</a></h2>
<p>We need several utility functions to properly process futures contract data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_third_friday</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the third Friday of a given month and year.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        year (int): Year</span>
<span class="sd">        month (int): Month (1-12)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        datetime: Date object for the third Friday</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Use calendar.monthcalendar: each week is a list of ints (0 if day not in month)</span>
    <span class="n">month_cal</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">monthcalendar</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>
    <span class="c1"># The first week that has a Friday (weekday index 4)</span>
    <span class="n">fridays</span> <span class="o">=</span> <span class="p">[</span><span class="n">week</span><span class="p">[</span><span class="n">calendar</span><span class="o">.</span><span class="n">FRIDAY</span><span class="p">]</span> <span class="k">for</span> <span class="n">week</span> <span class="ow">in</span> <span class="n">month_cal</span> <span class="k">if</span> <span class="n">week</span><span class="p">[</span><span class="n">calendar</span><span class="o">.</span><span class="n">FRIDAY</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fridays</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not enough Fridays in </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">fridays</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># third Friday</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_contract_month_year</span><span class="p">(</span><span class="n">contract_str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse Bloomberg&#39;s contract month/year string (e.g., &#39;DEC 10&#39;) into</span>
<span class="sd">    a month number and a full year.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        contract_str (str): Contract month/year string</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: (month_num, year_full) or (None, None) if invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">contract_str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">contract_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">contract_str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected contract format: </span><span class="si">{</span><span class="n">contract_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">month_abbr</span><span class="p">,</span> <span class="n">year_abbr</span> <span class="o">=</span> <span class="n">parts</span>
    <span class="n">allowed</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;MAR&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;JUN&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;SEP&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;DEC&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">month_abbr</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Contract month </span><span class="si">{</span><span class="n">month_abbr</span><span class="si">}</span><span class="s2"> not in allowed set </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">allowed</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">month_num</span> <span class="o">=</span> <span class="n">allowed</span><span class="p">[</span><span class="n">month_abbr</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">yr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year_abbr</span><span class="p">)</span>
        <span class="n">year_full</span> <span class="o">=</span> <span class="mi">2000</span> <span class="o">+</span> <span class="n">yr</span> <span class="k">if</span> <span class="n">yr</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="mi">1900</span> <span class="o">+</span> <span class="n">yr</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not parse year: </span><span class="si">{</span><span class="n">year_abbr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">month_num</span><span class="p">,</span> <span class="n">year_full</span>

<span class="c1"># Test our utility functions with a couple of examples</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Third Friday of March 2023: </span><span class="si">{</span><span class="n">get_third_friday</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parsing &#39;DEC 22&#39;: </span><span class="si">{</span><span class="n">parse_contract_month_year</span><span class="p">(</span><span class="s1">&#39;DEC 22&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parsing &#39;MAR 23&#39;: </span><span class="si">{</span><span class="n">parse_contract_month_year</span><span class="p">(</span><span class="s1">&#39;MAR 23&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Third Friday of March 2023: 2023-03-17 00:00:00
Parsing &#39;DEC 22&#39;: (12, 2022)
Parsing &#39;MAR 23&#39;: (3, 2023)
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-bloomberg-data">
<h2>Load Bloomberg Data<a class="headerlink" href="#load-bloomberg-data" title="Link to this heading">#</a></h2>
<p>Letâ€™s load the Bloomberg futures data from the Parquet file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">INPUT_FILE</span> <span class="o">=</span> <span class="n">INPUT_DIR</span> <span class="o">/</span> <span class="s2">&quot;bloomberg_historical_data.parquet&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">INPUT_FILE</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Primary input file not found, switching to cached data&quot;</span><span class="p">)</span>
        <span class="n">INPUT_FILE</span> <span class="o">=</span> <span class="n">DATA_MANUAL</span> <span class="o">/</span> <span class="s2">&quot;bloomberg_historical_data.parquet&quot;</span>
    
    <span class="n">raw_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">INPUT_FILE</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully loaded data from </span><span class="si">{</span><span class="n">INPUT_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Convert index to DatetimeIndex if it&#39;s not already</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">):</span>
        <span class="n">raw_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">raw_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converted index to DatetimeIndex&quot;</span><span class="p">)</span>
    
    <span class="c1"># Display the column structure (MultiIndex)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column levels: </span><span class="si">{</span><span class="n">raw_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sample of MultiIndex columns:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">raw_data</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">10</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ...and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">-</span><span class="mi">10</span><span class="si">}</span><span class="s2"> more columns&quot;</span><span class="p">)</span>
    
    <span class="c1"># Display basic info about the dataset</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Dataset shape: </span><span class="si">{</span><span class="n">raw_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Date range: </span><span class="si">{</span><span class="n">raw_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">raw_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">raise</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:26,229 - WARNING - Primary input file not found, switching to cached data
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:26,437 - INFO - Successfully loaded data from C:\Users\Andik\OneDrive\Desktop\Chicago\Full_stack_QF\Equity_Spot_futures_arb\data_manual\bloomberg_historical_data.parquet
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:26,440 - INFO - Column levels: [None, None]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sample of MultiIndex columns:
  (&#39;SPX Index&#39;, &#39;PX_LAST&#39;)
  (&#39;SPX Index&#39;, &#39;IDX_EST_DVD_YLD&#39;)
  (&#39;SPX Index&#39;, &#39;INDX_GROSS_DAILY_DIV&#39;)
  (&#39;NDX Index&#39;, &#39;PX_LAST&#39;)
  (&#39;NDX Index&#39;, &#39;IDX_EST_DVD_YLD&#39;)
  (&#39;NDX Index&#39;, &#39;INDX_GROSS_DAILY_DIV&#39;)
  (&#39;INDU Index&#39;, &#39;PX_LAST&#39;)
  (&#39;INDU Index&#39;, &#39;IDX_EST_DVD_YLD&#39;)
  (&#39;INDU Index&#39;, &#39;INDX_GROSS_DAILY_DIV&#39;)
  (&#39;ES1 Index&#39;, &#39;PX_LAST&#39;)
  ...and 52 more columns

Dataset shape: (3913, 62)
Date range: 2010-01-01 00:00:00 to 2024-12-31 00:00:00
</pre></div>
</div>
</div>
</div>
</section>
<section id="define-index-futures-mapping">
<h2>Define Index Futures Mapping<a class="headerlink" href="#define-index-futures-mapping" title="Link to this heading">#</a></h2>
<p>Letâ€™s define the mapping between equity indices and their futures contracts:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">indices</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;SPX&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;ES1&#39;</span><span class="p">,</span> <span class="s1">&#39;ES2&#39;</span><span class="p">,</span> <span class="s1">&#39;ES3&#39;</span><span class="p">,</span> <span class="s1">&#39;ES4&#39;</span><span class="p">],</span>  <span class="c1"># S&amp;P 500 futures</span>
    <span class="s1">&#39;NDX&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;NQ1&#39;</span><span class="p">,</span> <span class="s1">&#39;NQ2&#39;</span><span class="p">,</span> <span class="s1">&#39;NQ3&#39;</span><span class="p">,</span> <span class="s1">&#39;NQ4&#39;</span><span class="p">],</span>  <span class="c1"># Nasdaq 100 futures</span>
    <span class="s1">&#39;INDU&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;DM1&#39;</span><span class="p">,</span> <span class="s1">&#39;DM2&#39;</span><span class="p">,</span> <span class="s1">&#39;DM3&#39;</span><span class="p">,</span> <span class="s1">&#39;DM4&#39;</span><span class="p">]</span>  <span class="c1"># Dow Jones futures</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Equity indices and their futures contracts:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">futures</span> <span class="ow">in</span> <span class="n">indices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Equity indices and their futures contracts:
  SPX: ES1, ES2, ES3, ES4
  NDX: NQ1, NQ2, NQ3, NQ4
  INDU: DM1, DM2, DM3, DM4
</pre></div>
</div>
</div>
</div>
</section>
<section id="process-futures-data">
<h2>Process Futures Data<a class="headerlink" href="#process-futures-data" title="Link to this heading">#</a></h2>
<p>Now, letâ€™s implement the function that processes futures data for a single index:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">process_index_futures</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">futures_codes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process futures data for one index.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        data (pd.DataFrame): Multi-index DataFrame with Bloomberg data (indexed by Date)</span>
<span class="sd">        futures_codes (list): List of futures codes (e.g., [&#39;ES1&#39;, &#39;ES2&#39;, ...])</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary of processed DataFrames, one for each futures code.</span>
<span class="sd">              Each DataFrame contains:</span>
<span class="sd">                  - Date</span>
<span class="sd">                  - Futures_Price (from PX_LAST)</span>
<span class="sd">                  - Volume, OpenInterest (if available)</span>
<span class="sd">                  - ContractSpec (raw CURRENT_CONTRACT_MONTH_YR)</span>
<span class="sd">                  - SettlementDate (actual settlement, 3rd Friday)</span>
<span class="sd">                  - TTM (time-to-maturity in days)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result_dfs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">futures_codes</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing futures data for </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2"> Index&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Extract columns for this contract</span>
            <span class="n">price_series</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1"> Index&#39;</span><span class="p">,</span> <span class="s1">&#39;PX_LAST&#39;</span><span class="p">)]</span>
            <span class="n">volume_series</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1"> Index&#39;</span><span class="p">,</span> <span class="s1">&#39;PX_VOLUME&#39;</span><span class="p">)]</span>
            <span class="n">oi_series</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1"> Index&#39;</span><span class="p">,</span> <span class="s1">&#39;OPEN_INT&#39;</span><span class="p">)]</span>
            <span class="n">contract_series</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1"> Index&#39;</span><span class="p">,</span> <span class="s1">&#39;CURRENT_CONTRACT_MONTH_YR&#39;</span><span class="p">)]</span>
            
            <span class="c1"># Create a DataFrame for this contract; index is Date (from raw data)</span>
            <span class="n">df_contract</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="s1">&#39;Futures_Price&#39;</span><span class="p">:</span> <span class="n">price_series</span><span class="p">,</span>
                <span class="s1">&#39;Volume&#39;</span><span class="p">:</span> <span class="n">volume_series</span><span class="p">,</span>
                <span class="s1">&#39;OpenInterest&#39;</span><span class="p">:</span> <span class="n">oi_series</span><span class="p">,</span>
                <span class="s1">&#39;ContractSpec&#39;</span><span class="p">:</span> <span class="n">contract_series</span>
            <span class="p">})</span>
            <span class="n">df_contract</span> <span class="o">=</span> <span class="n">df_contract</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="c1"># Parse contract specification and compute settlement date</span>
            <span class="n">settlement_dates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cs</span> <span class="ow">in</span> <span class="n">df_contract</span><span class="p">[</span><span class="s1">&#39;ContractSpec&#39;</span><span class="p">]:</span>
                <span class="n">month_num</span><span class="p">,</span> <span class="n">year_full</span> <span class="o">=</span> <span class="n">parse_contract_month_year</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">month_num</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">year_full</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">settlement_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">settlement_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_third_friday</span><span class="p">(</span><span class="n">year_full</span><span class="p">,</span> <span class="n">month_num</span><span class="p">))</span>
            <span class="n">df_contract</span><span class="p">[</span><span class="s1">&#39;SettlementDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">settlement_dates</span><span class="p">)</span>
            
            <span class="c1"># Compute TTM in days: SettlementDate - Date</span>
            <span class="n">df_contract</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_contract</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span>
            <span class="n">df_contract</span><span class="p">[</span><span class="s1">&#39;TTM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_contract</span><span class="p">[</span><span class="s1">&#39;SettlementDate&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_contract</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>
            
            <span class="c1"># Drop rows with missing TTM (if settlement date couldn&#39;t be computed)</span>
            <span class="n">df_contract</span> <span class="o">=</span> <span class="n">df_contract</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;TTM&#39;</span><span class="p">])</span>
            <span class="n">result_dfs</span><span class="p">[</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_contract</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_contract</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
    <span class="k">return</span> <span class="n">result_dfs</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="process-all-indices">
<h2>Process All Indices<a class="headerlink" href="#process-all-indices" title="Link to this heading">#</a></h2>
<p>Letâ€™s apply our processing function to all indices:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">all_futures</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">index_code</span><span class="p">,</span> <span class="n">futures_codes</span> <span class="ow">in</span> <span class="n">indices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing futures for index </span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="n">process_index_futures</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">futures_codes</span><span class="p">)</span>
    <span class="n">all_futures</span><span class="p">[</span><span class="n">index_code</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed</span>
    
    <span class="c1"># Display a sample of the processed data for each index</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processed Futures for </span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">processed</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2"> - Shape: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:26,567 - INFO - Processing futures for index SPX
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:26,571 - INFO - Processing futures data for ES1 Index
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:26,729 - INFO - Processed ES1: 3781 rows
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:26,731 - INFO - Processing futures data for ES2 Index
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:26,871 - INFO - Processed ES2: 3781 rows
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:26,876 - INFO - Processing futures data for ES3 Index
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:27,017 - INFO - Processed ES3: 3781 rows
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:27,021 - INFO - Processing futures data for ES4 Index
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:27,158 - INFO - Processed ES4: 3781 rows
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Processed Futures for SPX:
  ES1 - Shape: (3781, 7)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Futures_Price</th>
      <th>Volume</th>
      <th>OpenInterest</th>
      <th>ContractSpec</th>
      <th>SettlementDate</th>
      <th>TTM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>2010-01-04</td>
      <td>1128.75</td>
      <td>1282633.0</td>
      <td>2440458.0</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>74.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-05</td>
      <td>1132.25</td>
      <td>1368386.0</td>
      <td>2402850.0</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>73.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-06</td>
      <td>1133.00</td>
      <td>1252015.0</td>
      <td>2396493.0</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>72.0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  ES2 - Shape: (3781, 7)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Futures_Price</th>
      <th>Volume</th>
      <th>OpenInterest</th>
      <th>ContractSpec</th>
      <th>SettlementDate</th>
      <th>TTM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>2010-01-04</td>
      <td>1124.0</td>
      <td>1641.0</td>
      <td>3354.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>165.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-05</td>
      <td>1127.5</td>
      <td>686.0</td>
      <td>3432.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>164.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-06</td>
      <td>1128.0</td>
      <td>1163.0</td>
      <td>3713.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>163.0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  ES3 - Shape: (3781, 7)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Futures_Price</th>
      <th>Volume</th>
      <th>OpenInterest</th>
      <th>ContractSpec</th>
      <th>SettlementDate</th>
      <th>TTM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>2010-01-04</td>
      <td>1119.5</td>
      <td>100.0</td>
      <td>439.0</td>
      <td>SEP 10</td>
      <td>2010-09-17</td>
      <td>256.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-05</td>
      <td>1123.0</td>
      <td>300.0</td>
      <td>539.0</td>
      <td>SEP 10</td>
      <td>2010-09-17</td>
      <td>255.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-06</td>
      <td>1123.5</td>
      <td>601.0</td>
      <td>1140.0</td>
      <td>SEP 10</td>
      <td>2010-09-17</td>
      <td>254.0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  ES4 - Shape: (3781, 7)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Futures_Price</th>
      <th>Volume</th>
      <th>OpenInterest</th>
      <th>ContractSpec</th>
      <th>SettlementDate</th>
      <th>TTM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>2010-01-04</td>
      <td>1116.5</td>
      <td>NaN</td>
      <td>6.0</td>
      <td>DEC 10</td>
      <td>2010-12-17</td>
      <td>347.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-05</td>
      <td>1120.0</td>
      <td>4.0</td>
      <td>8.0</td>
      <td>DEC 10</td>
      <td>2010-12-17</td>
      <td>346.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-06</td>
      <td>1120.5</td>
      <td>NaN</td>
      <td>8.0</td>
      <td>DEC 10</td>
      <td>2010-12-17</td>
      <td>345.0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:27,244 - INFO - Processing futures for index NDX
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:27,251 - INFO - Processing futures data for NQ1 Index
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:27,394 - INFO - Processed NQ1: 3781 rows
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:27,398 - INFO - Processing futures data for NQ2 Index
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:27,554 - INFO - Processed NQ2: 3781 rows
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:27,560 - INFO - Processing futures data for NQ3 Index
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:27,714 - INFO - Processed NQ3: 3781 rows
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:27,718 - INFO - Processing futures data for NQ4 Index
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:27,869 - INFO - Processed NQ4: 3781 rows
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Processed Futures for NDX:
  NQ1 - Shape: (3781, 7)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Futures_Price</th>
      <th>Volume</th>
      <th>OpenInterest</th>
      <th>ContractSpec</th>
      <th>SettlementDate</th>
      <th>TTM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>2010-01-04</td>
      <td>1886.75</td>
      <td>204140.0</td>
      <td>314877.0</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>74.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-05</td>
      <td>1885.25</td>
      <td>207245.0</td>
      <td>309080.0</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>73.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-06</td>
      <td>1878.50</td>
      <td>259627.0</td>
      <td>310532.0</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>72.0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  NQ2 - Shape: (3781, 7)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Futures_Price</th>
      <th>Volume</th>
      <th>OpenInterest</th>
      <th>ContractSpec</th>
      <th>SettlementDate</th>
      <th>TTM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>2010-01-04</td>
      <td>1884.75</td>
      <td>33.0</td>
      <td>671.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>165.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-05</td>
      <td>1883.00</td>
      <td>74.0</td>
      <td>651.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>164.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-06</td>
      <td>1876.50</td>
      <td>33.0</td>
      <td>665.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>163.0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  NQ3 - Shape: (3781, 7)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Futures_Price</th>
      <th>Volume</th>
      <th>OpenInterest</th>
      <th>ContractSpec</th>
      <th>SettlementDate</th>
      <th>TTM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>2010-01-04</td>
      <td>1883.75</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>SEP 10</td>
      <td>2010-09-17</td>
      <td>256.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-05</td>
      <td>1882.00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>SEP 10</td>
      <td>2010-09-17</td>
      <td>255.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-06</td>
      <td>1875.50</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>SEP 10</td>
      <td>2010-09-17</td>
      <td>254.0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  NQ4 - Shape: (3781, 7)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Futures_Price</th>
      <th>Volume</th>
      <th>OpenInterest</th>
      <th>ContractSpec</th>
      <th>SettlementDate</th>
      <th>TTM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>2010-01-04</td>
      <td>1882.75</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>DEC 10</td>
      <td>2010-12-17</td>
      <td>347.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-05</td>
      <td>1881.00</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>DEC 10</td>
      <td>2010-12-17</td>
      <td>346.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-06</td>
      <td>1874.50</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>DEC 10</td>
      <td>2010-12-17</td>
      <td>345.0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:27,959 - INFO - Processing futures for index INDU
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:27,961 - INFO - Processing futures data for DM1 Index
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:28,110 - INFO - Processed DM1: 3780 rows
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:28,111 - INFO - Processing futures data for DM2 Index
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:28,252 - INFO - Processed DM2: 3780 rows
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:28,255 - INFO - Processing futures data for DM3 Index
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:28,430 - INFO - Processed DM3: 3780 rows
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:28,435 - INFO - Processing futures data for DM4 Index
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-03-11 04:10:28,591 - INFO - Processed DM4: 3780 rows
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Processed Futures for INDU:
  DM1 - Shape: (3780, 7)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Futures_Price</th>
      <th>Volume</th>
      <th>OpenInterest</th>
      <th>ContractSpec</th>
      <th>SettlementDate</th>
      <th>TTM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>2010-01-04</td>
      <td>10519.0</td>
      <td>93770.0</td>
      <td>69420.0</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>74.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-05</td>
      <td>10515.0</td>
      <td>93287.0</td>
      <td>65749.0</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>73.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-06</td>
      <td>10516.0</td>
      <td>97172.0</td>
      <td>63888.0</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>72.0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  DM2 - Shape: (3780, 7)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Futures_Price</th>
      <th>Volume</th>
      <th>OpenInterest</th>
      <th>ContractSpec</th>
      <th>SettlementDate</th>
      <th>TTM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>2010-01-04</td>
      <td>10459.0</td>
      <td>100.0</td>
      <td>175.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>165.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-05</td>
      <td>10455.0</td>
      <td>26.0</td>
      <td>173.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>164.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-06</td>
      <td>10455.0</td>
      <td>157.0</td>
      <td>193.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>163.0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  DM3 - Shape: (3780, 7)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Futures_Price</th>
      <th>Volume</th>
      <th>OpenInterest</th>
      <th>ContractSpec</th>
      <th>SettlementDate</th>
      <th>TTM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>2010-01-04</td>
      <td>10404.0</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>SEP 10</td>
      <td>2010-09-17</td>
      <td>256.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-05</td>
      <td>10400.0</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>SEP 10</td>
      <td>2010-09-17</td>
      <td>255.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-06</td>
      <td>10400.0</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>SEP 10</td>
      <td>2010-09-17</td>
      <td>254.0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  DM4 - Shape: (3780, 7)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Futures_Price</th>
      <th>Volume</th>
      <th>OpenInterest</th>
      <th>ContractSpec</th>
      <th>SettlementDate</th>
      <th>TTM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>2010-01-04</td>
      <td>10354.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>DEC 10</td>
      <td>2010-12-17</td>
      <td>347.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-05</td>
      <td>10350.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>DEC 10</td>
      <td>2010-12-17</td>
      <td>346.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-06</td>
      <td>10351.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>DEC 10</td>
      <td>2010-12-17</td>
      <td>345.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="analyze-contract-roll-patterns">
<h2>Analyze Contract Roll Patterns<a class="headerlink" href="#analyze-contract-roll-patterns" title="Link to this heading">#</a></h2>
<p>Letâ€™s visualize how contracts roll over time for one of the indices:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Choose SPX ES1 (front-month) contract for visualization</span>
<span class="n">es1_df</span> <span class="o">=</span> <span class="n">all_futures</span><span class="p">[</span><span class="s1">&#39;SPX&#39;</span><span class="p">][</span><span class="s1">&#39;ES1&#39;</span><span class="p">]</span>

<span class="c1"># Plot settlement date changes over time to visualize contract rolls</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">es1_df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span> <span class="n">es1_df</span><span class="p">[</span><span class="s1">&#39;SettlementDate&#39;</span><span class="p">],</span> <span class="s1">&#39;b.-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;ES1 Contract Settlement Date Over Time (Contract Roll Pattern)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Settlement Date&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># Save the visualization</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_DIR</span> <span class="o">/</span> <span class="s1">&#39;es1_contract_roll_pattern.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Analyze TTM distribution for ES1</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">es1_df</span><span class="p">[</span><span class="s1">&#39;TTM&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">es1_df</span><span class="p">[</span><span class="s1">&#39;TTM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mean: </span><span class="si">{</span><span class="n">es1_df</span><span class="p">[</span><span class="s2">&quot;TTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> days&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribution of Time-to-Maturity (TTM) for ES1 Contract&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Days to Maturity&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># Save the visualization</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_DIR</span> <span class="o">/</span> <span class="s1">&#39;es1_ttm_distribution.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e2ff3af5ddeb87b36bf76a8f0522c170b2e6953663f38adcbbd362536b5c1d67.png" src="../_images/e2ff3af5ddeb87b36bf76a8f0522c170b2e6953663f38adcbbd362536b5c1d67.png" />
<img alt="../_images/683b9d53e3738c5e57e7876a816c52750dfd3747defe19afb568b183b8e24aa0.png" src="../_images/683b9d53e3738c5e57e7876a816c52750dfd3747defe19afb568b183b8e24aa0.png" />
</div>
</div>
</section>
<section id="create-calendar-spreads">
<h2>Create Calendar Spreads<a class="headerlink" href="#create-calendar-spreads" title="Link to this heading">#</a></h2>
<p>Now letâ€™s implement the function to merge the Term 1 (nearest) and Term 2 (next nearest) contracts to create calendar spreads:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">merge_calendar_spreads</span><span class="p">(</span><span class="n">all_futures</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each index, merge the processed data for the two nearest futures contracts (Term 1 and Term 2)</span>
<span class="sd">    on the Date field, and then combine the calendar spreads for all indices.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        all_futures (dict): Dictionary keyed by index code (e.g., &#39;SPX&#39;, &#39;NDX&#39;, &#39;INDU&#39;) where the value is</span>
<span class="sd">                            another dictionary mapping futures code to its processed DataFrame.</span>
<span class="sd">                            </span>
<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Combined calendar spread data for all indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># For each index, the first two codes are the two nearest contracts.</span>
    <span class="k">for</span> <span class="n">index_code</span><span class="p">,</span> <span class="n">fut_dict</span> <span class="ow">in</span> <span class="n">all_futures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Identify term1 and term2 codes:</span>
        <span class="n">codes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fut_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">codes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not enough futures data for </span><span class="si">{</span><span class="n">index_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="n">fut_dict</span><span class="p">[</span><span class="n">codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="n">fut_dict</span><span class="p">[</span><span class="n">codes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Add a prefix so that we can merge and distinguish columns:</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="n">term1</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;Term1_&#39;</span><span class="p">)</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="n">term2</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;Term2_&#39;</span><span class="p">)</span>
        <span class="c1"># Rename the Date columns back to &#39;Date&#39; for merging</span>
        <span class="n">term1</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Term1_Date&#39;</span><span class="p">:</span> <span class="s1">&#39;Date&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">term2</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Term2_Date&#39;</span><span class="p">:</span> <span class="s1">&#39;Date&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">term1</span><span class="p">,</span> <span class="n">term2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
        <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;Index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_code</span>
        <span class="n">combined</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">combined</span><span class="p">:</span>
        <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">combined</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">combined_df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No valid calendar spread data to combine&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-and-analyze-calendar-spreads">
<h2>Create and Analyze Calendar Spreads<a class="headerlink" href="#create-and-analyze-calendar-spreads" title="Link to this heading">#</a></h2>
<p>Letâ€™s apply the function to create calendar spreads and analyze the results:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create calendar spreads</span>
<span class="n">combined_spreads</span> <span class="o">=</span> <span class="n">merge_calendar_spreads</span><span class="p">(</span><span class="n">all_futures</span><span class="p">)</span>

<span class="c1"># Display a sample of the calendar spread data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sample of Combined Calendar Spread Data:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">combined_spreads</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="c1"># Check key statistics for calendar spreads</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calendar Spread Statistics by Index:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="n">index_df</span> <span class="o">=</span> <span class="n">combined_spreads</span><span class="p">[</span><span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">index</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> Index:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Number of observations: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">index_df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Average Term1 TTM: </span><span class="si">{</span><span class="n">index_df</span><span class="p">[</span><span class="s1">&#39;Term1_TTM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> days&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Average Term2 TTM: </span><span class="si">{</span><span class="n">index_df</span><span class="p">[</span><span class="s1">&#39;Term2_TTM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> days&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Average calendar spread (TTM2 - TTM1): </span><span class="si">{</span><span class="p">(</span><span class="n">index_df</span><span class="p">[</span><span class="s1">&#39;Term2_TTM&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">index_df</span><span class="p">[</span><span class="s1">&#39;Term1_TTM&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> days&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sample of Combined Calendar Spread Data:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Term1_Futures_Price</th>
      <th>Term1_Volume</th>
      <th>Term1_OpenInterest</th>
      <th>Term1_ContractSpec</th>
      <th>Term1_SettlementDate</th>
      <th>Term1_TTM</th>
      <th>Term2_Futures_Price</th>
      <th>Term2_Volume</th>
      <th>Term2_OpenInterest</th>
      <th>Term2_ContractSpec</th>
      <th>Term2_SettlementDate</th>
      <th>Term2_TTM</th>
      <th>Index</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2010-01-04</td>
      <td>1128.75</td>
      <td>1282633.0</td>
      <td>2440458.0</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>74.0</td>
      <td>1124.00</td>
      <td>1641.0</td>
      <td>3354.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>165.0</td>
      <td>SPX</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2010-01-05</td>
      <td>1132.25</td>
      <td>1368386.0</td>
      <td>2402850.0</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>73.0</td>
      <td>1127.50</td>
      <td>686.0</td>
      <td>3432.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>164.0</td>
      <td>SPX</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-06</td>
      <td>1133.00</td>
      <td>1252015.0</td>
      <td>2396493.0</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>72.0</td>
      <td>1128.00</td>
      <td>1163.0</td>
      <td>3713.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>163.0</td>
      <td>SPX</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-07</td>
      <td>1137.50</td>
      <td>1553963.0</td>
      <td>2406352.0</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>71.0</td>
      <td>1132.50</td>
      <td>1135.0</td>
      <td>4154.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>162.0</td>
      <td>SPX</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2010-01-08</td>
      <td>1141.50</td>
      <td>1508175.0</td>
      <td>2758348.0</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>70.0</td>
      <td>1136.75</td>
      <td>1080.0</td>
      <td>17466.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>161.0</td>
      <td>SPX</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calendar Spread Statistics by Index:

SPX Index:
  Number of observations: 3781
  Average Term1 TTM: 44.01 days
  Average Term2 TTM: 135.33 days
  Average calendar spread (TTM2 - TTM1): 91.32 days

NDX Index:
  Number of observations: 3781
  Average Term1 TTM: 44.01 days
  Average Term2 TTM: 135.33 days
  Average calendar spread (TTM2 - TTM1): 91.32 days

INDU Index:
  Number of observations: 3780
  Average Term1 TTM: 44.01 days
  Average Term2 TTM: 135.32 days
  Average calendar spread (TTM2 - TTM1): 91.32 days
</pre></div>
</div>
</div>
</div>
<p>It makes sense that the average calendar spread is over 3 months between contract 1 and contract 2</p>
</section>
<section id="data-quality-checks">
<h2>Data Quality Checks<a class="headerlink" href="#data-quality-checks" title="Link to this heading">#</a></h2>
<p>Letâ€™s perform some data quality checks on our processed futures data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">check_futures_data_quality</span><span class="p">(</span><span class="n">combined_spreads</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform data quality checks on the processed futures data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running data quality checks on futures data...&quot;</span><span class="p">)</span>
    <span class="n">tests_passed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tests_failed</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># Test 1: Check that we have data for all three indices</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">expected_indices</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPX&#39;</span><span class="p">,</span> <span class="s1">&#39;NDX&#39;</span><span class="p">,</span> <span class="s1">&#39;INDU&#39;</span><span class="p">}</span>
        <span class="n">actual_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="k">assert</span> <span class="n">expected_indices</span> <span class="o">==</span> <span class="n">actual_indices</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Missing indices: </span><span class="si">{</span><span class="n">expected_indices</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">actual_indices</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 1 Passed: All three indices are present&quot;</span><span class="p">)</span>
        <span class="n">tests_passed</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 1 Failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tests_failed</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="c1"># Test 2: Check that Term2_TTM &gt; Term1_TTM for all rows</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Term2_TTM&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Term1_TTM&#39;</span><span class="p">]),</span> <span class="s2">&quot;Term2 TTM should always be greater than Term1 TTM&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 2 Passed: Term2 TTM is always greater than Term1 TTM&quot;</span><span class="p">)</span>
        <span class="n">tests_passed</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 2 Failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tests_failed</span> <span class="o">+=</span> <span class="mi">1</span>
        
    <span class="c1"># Test 3: Check that all TTM values are reasonable (positive and typically under 365 days)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Term1_TTM&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Term1 TTM should be positive&quot;</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Term2_TTM&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Term2 TTM should be positive&quot;</span>
        <span class="k">assert</span> <span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Term1_TTM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">365</span><span class="p">,</span> <span class="s2">&quot;Term1 TTM should typically be less than 365 days&quot;</span>
        <span class="k">assert</span> <span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Term2_TTM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">730</span><span class="p">,</span> <span class="s2">&quot;Term2 TTM should typically be less than 730 days&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 3 Passed: TTM values are within reasonable ranges&quot;</span><span class="p">)</span>
        <span class="n">tests_passed</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 3 Failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tests_failed</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="c1"># Test 4: Check for missing values in critical columns</span>
    <span class="n">critical_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Term1_Futures_Price&#39;</span><span class="p">,</span> <span class="s1">&#39;Term2_Futures_Price&#39;</span><span class="p">,</span> <span class="s1">&#39;Term1_TTM&#39;</span><span class="p">,</span> <span class="s1">&#39;Term2_TTM&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">critical_columns</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">combined_spreads</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Missing values in </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 4 Passed: No missing values in critical columns&quot;</span><span class="p">)</span>
        <span class="n">tests_passed</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 4 Failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tests_failed</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="c1"># Test 5: Check that futures prices are positive</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Term1_Futures_Price&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Term1 futures prices should be positive&quot;</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Term2_Futures_Price&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Term2 futures prices should be positive&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 5 Passed: All futures prices are positive&quot;</span><span class="p">)</span>
        <span class="n">tests_passed</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 5 Failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tests_failed</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data quality checks complete: </span><span class="si">{</span><span class="n">tests_passed</span><span class="si">}</span><span class="s2"> passed, </span><span class="si">{</span><span class="n">tests_failed</span><span class="si">}</span><span class="s2"> failed&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tests_passed</span><span class="p">,</span> <span class="n">tests_failed</span>

<span class="c1"># Run the data quality checks</span>
<span class="n">tests_passed</span><span class="p">,</span> <span class="n">tests_failed</span> <span class="o">=</span> <span class="n">check_futures_data_quality</span><span class="p">(</span><span class="n">combined_spreads</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">check_futures_data_quality</span><span class="p">(</span><span class="n">combined_spreads</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform data quality checks on the processed futures data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running data quality checks on futures data...&quot;</span><span class="p">)</span>
    <span class="n">tests_passed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tests_failed</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># Test 1: Check that we have data for all three indices</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">expected_indices</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPX&#39;</span><span class="p">,</span> <span class="s1">&#39;NDX&#39;</span><span class="p">,</span> <span class="s1">&#39;INDU&#39;</span><span class="p">}</span>
        <span class="n">actual_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="k">assert</span> <span class="n">expected_indices</span> <span class="o">==</span> <span class="n">actual_indices</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Missing indices: </span><span class="si">{</span><span class="n">expected_indices</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">actual_indices</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 1 Passed: All three indices are present&quot;</span><span class="p">)</span>
        <span class="n">tests_passed</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 1 Failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tests_failed</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="c1"># Test 2: Check that Term2_TTM &gt; Term1_TTM for all rows</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Term2_TTM&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Term1_TTM&#39;</span><span class="p">]),</span> <span class="s2">&quot;Term2 TTM should always be greater than Term1 TTM&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 2 Passed: Term2 TTM is always greater than Term1 TTM&quot;</span><span class="p">)</span>
        <span class="n">tests_passed</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 2 Failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tests_failed</span> <span class="o">+=</span> <span class="mi">1</span>
        
    <span class="c1"># Test 3: Check that all TTM values are reasonable (positive and typically under 365 days)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Term1_TTM&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Term1 TTM should be positive&quot;</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Term2_TTM&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Term2 TTM should be positive&quot;</span>
        <span class="k">assert</span> <span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Term1_TTM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">365</span><span class="p">,</span> <span class="s2">&quot;Term1 TTM should typically be less than 365 days&quot;</span>
        <span class="k">assert</span> <span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Term2_TTM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">730</span><span class="p">,</span> <span class="s2">&quot;Term2 TTM should typically be less than 730 days&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 3 Passed: TTM values are within reasonable ranges&quot;</span><span class="p">)</span>
        <span class="n">tests_passed</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 3 Failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tests_failed</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="c1"># Test 4: Check for missing values in critical columns</span>
    <span class="n">critical_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Term1_Futures_Price&#39;</span><span class="p">,</span> <span class="s1">&#39;Term2_Futures_Price&#39;</span><span class="p">,</span> <span class="s1">&#39;Term1_TTM&#39;</span><span class="p">,</span> <span class="s1">&#39;Term2_TTM&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">critical_columns</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">combined_spreads</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Missing values in </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 4 Passed: No missing values in critical columns&quot;</span><span class="p">)</span>
        <span class="n">tests_passed</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 4 Failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tests_failed</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="c1"># Test 5: Check that futures prices are positive</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Term1_Futures_Price&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Term1 futures prices should be positive&quot;</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Term2_Futures_Price&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Term2 futures prices should be positive&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 5 Passed: All futures prices are positive&quot;</span><span class="p">)</span>
        <span class="n">tests_passed</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test 5 Failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tests_failed</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data quality checks complete: </span><span class="si">{</span><span class="n">tests_passed</span><span class="si">}</span><span class="s2"> passed, </span><span class="si">{</span><span class="n">tests_failed</span><span class="si">}</span><span class="s2"> failed&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tests_passed</span><span class="p">,</span> <span class="n">tests_failed</span>

<span class="c1"># Run the data quality checks</span>
<span class="n">tests_passed</span><span class="p">,</span> <span class="n">tests_failed</span> <span class="o">=</span> <span class="n">check_futures_data_quality</span><span class="p">(</span><span class="n">combined_spreads</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Running data quality checks on futures data...
Test 1 Passed: All three indices are present
Test 2 Passed: Term2 TTM is always greater than Term1 TTM
Test 3 Failed: Term1 TTM should be positive
Test 4 Passed: No missing values in critical columns
Test 5 Passed: All futures prices are positive

Data quality checks complete: 4 passed, 1 failed
Running data quality checks on futures data...
Test 1 Passed: All three indices are present
Test 2 Passed: Term2 TTM is always greater than Term1 TTM
Test 3 Failed: Term1 TTM should be positive
Test 4 Passed: No missing values in critical columns
Test 5 Passed: All futures prices are positive

Data quality checks complete: 4 passed, 1 failed
</pre></div>
</div>
</div>
</div>
<p>Interestingly, we do see a failed test case where TTM for Term 1 was not positive.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Identify rows where Term1_TTM is not positive</span>
<span class="n">problematic_rows</span> <span class="o">=</span> <span class="n">combined_spreads</span><span class="p">[</span><span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Term1_TTM&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span>

<span class="c1"># Display the count of problematic rows</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">problematic_rows</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows with non-positive Term1_TTM values&quot;</span><span class="p">)</span>

<span class="c1"># Display the problematic rows</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">problematic_rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Rows with non-positive Term1_TTM values:&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">problematic_rows</span><span class="p">)</span>
    
    <span class="c1"># Group by index to see distribution of issues</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Distribution by index:&quot;</span><span class="p">)</span>
    <span class="n">index_counts</span> <span class="o">=</span> <span class="n">problematic_rows</span><span class="p">[</span><span class="s1">&#39;Index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">display</span><span class="p">(</span><span class="n">index_counts</span><span class="p">)</span>
    
    <span class="c1"># Look at the date distribution</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Date range of problematic rows:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Earliest: </span><span class="si">{</span><span class="n">problematic_rows</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Latest: </span><span class="si">{</span><span class="n">problematic_rows</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check term 2 values for these rows</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Term2_TTM statistics for these rows:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Min: </span><span class="si">{</span><span class="n">problematic_rows</span><span class="p">[</span><span class="s1">&#39;Term2_TTM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max: </span><span class="si">{</span><span class="n">problematic_rows</span><span class="p">[</span><span class="s1">&#39;Term2_TTM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean: </span><span class="si">{</span><span class="n">problematic_rows</span><span class="p">[</span><span class="s1">&#39;Term2_TTM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># See if we can identify a pattern</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sample of original contract specifications for these rows:&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">problematic_rows</span><span class="p">[[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Index&#39;</span><span class="p">,</span> <span class="s1">&#39;Term1_ContractSpec&#39;</span><span class="p">,</span> <span class="s1">&#39;Term1_SettlementDate&#39;</span><span class="p">,</span> <span class="s1">&#39;Term1_TTM&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found 180 rows with non-positive Term1_TTM values

Rows with non-positive Term1_TTM values:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Term1_Futures_Price</th>
      <th>Term1_Volume</th>
      <th>Term1_OpenInterest</th>
      <th>Term1_ContractSpec</th>
      <th>Term1_SettlementDate</th>
      <th>Term1_TTM</th>
      <th>Term2_Futures_Price</th>
      <th>Term2_Volume</th>
      <th>Term2_OpenInterest</th>
      <th>Term2_ContractSpec</th>
      <th>Term2_SettlementDate</th>
      <th>Term2_TTM</th>
      <th>Index</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>52</th>
      <td>2010-03-19</td>
      <td>1172.95</td>
      <td>57789.0</td>
      <td>NaN</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>0.0</td>
      <td>1156.25</td>
      <td>2165610.0</td>
      <td>2364398.0</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>91.0</td>
      <td>SPX</td>
    </tr>
    <tr>
      <th>115</th>
      <td>2010-06-18</td>
      <td>1118.83</td>
      <td>58546.0</td>
      <td>NaN</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>0.0</td>
      <td>1110.25</td>
      <td>1630832.0</td>
      <td>2533026.0</td>
      <td>SEP 10</td>
      <td>2010-09-17</td>
      <td>91.0</td>
      <td>SPX</td>
    </tr>
    <tr>
      <th>178</th>
      <td>2010-09-17</td>
      <td>1133.00</td>
      <td>74961.0</td>
      <td>NaN</td>
      <td>SEP 10</td>
      <td>2010-09-17</td>
      <td>0.0</td>
      <td>1119.75</td>
      <td>1929510.0</td>
      <td>2436902.0</td>
      <td>DEC 10</td>
      <td>2010-12-17</td>
      <td>91.0</td>
      <td>SPX</td>
    </tr>
    <tr>
      <th>242</th>
      <td>2010-12-17</td>
      <td>1242.35</td>
      <td>47534.0</td>
      <td>NaN</td>
      <td>DEC 10</td>
      <td>2010-12-17</td>
      <td>0.0</td>
      <td>1238.50</td>
      <td>1338470.0</td>
      <td>2392696.0</td>
      <td>MAR 11</td>
      <td>2011-03-18</td>
      <td>91.0</td>
      <td>SPX</td>
    </tr>
    <tr>
      <th>304</th>
      <td>2011-03-18</td>
      <td>1291.00</td>
      <td>90105.0</td>
      <td>NaN</td>
      <td>MAR 11</td>
      <td>2011-03-18</td>
      <td>0.0</td>
      <td>1274.25</td>
      <td>2335018.0</td>
      <td>2565944.0</td>
      <td>JUN 11</td>
      <td>2011-06-17</td>
      <td>91.0</td>
      <td>SPX</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>11080</th>
      <td>2023-12-15</td>
      <td>36996.45</td>
      <td>3063.0</td>
      <td>28709.0</td>
      <td>DEC 23</td>
      <td>2023-12-15</td>
      <td>0.0</td>
      <td>37661.00</td>
      <td>158088.0</td>
      <td>93658.0</td>
      <td>MAR 24</td>
      <td>2024-03-15</td>
      <td>91.0</td>
      <td>INDU</td>
    </tr>
    <tr>
      <th>11141</th>
      <td>2024-03-15</td>
      <td>38691.18</td>
      <td>1475.0</td>
      <td>21587.0</td>
      <td>MAR 24</td>
      <td>2024-03-15</td>
      <td>0.0</td>
      <td>39153.00</td>
      <td>168986.0</td>
      <td>92119.0</td>
      <td>JUN 24</td>
      <td>2024-06-21</td>
      <td>98.0</td>
      <td>INDU</td>
    </tr>
    <tr>
      <th>11208</th>
      <td>2024-06-21</td>
      <td>39261.95</td>
      <td>910.0</td>
      <td>27512.0</td>
      <td>JUN 24</td>
      <td>2024-06-21</td>
      <td>0.0</td>
      <td>39583.00</td>
      <td>120696.0</td>
      <td>79168.0</td>
      <td>SEP 24</td>
      <td>2024-09-20</td>
      <td>91.0</td>
      <td>INDU</td>
    </tr>
    <tr>
      <th>11271</th>
      <td>2024-09-20</td>
      <td>41946.09</td>
      <td>1513.0</td>
      <td>13934.0</td>
      <td>SEP 24</td>
      <td>2024-09-20</td>
      <td>0.0</td>
      <td>42443.00</td>
      <td>114933.0</td>
      <td>84305.0</td>
      <td>DEC 24</td>
      <td>2024-12-20</td>
      <td>91.0</td>
      <td>INDU</td>
    </tr>
    <tr>
      <th>11335</th>
      <td>2024-12-20</td>
      <td>42197.66</td>
      <td>2504.0</td>
      <td>20986.0</td>
      <td>DEC 24</td>
      <td>2024-12-20</td>
      <td>0.0</td>
      <td>43316.00</td>
      <td>161904.0</td>
      <td>83805.0</td>
      <td>MAR 25</td>
      <td>2025-03-21</td>
      <td>91.0</td>
      <td>INDU</td>
    </tr>
  </tbody>
</table>
<p>180 rows Ã— 14 columns</p>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribution by index:
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index
SPX     60
NDX     60
INDU    60
Name: count, dtype: int64
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Date range of problematic rows:
Earliest: 2010-03-19 00:00:00
Latest: 2024-12-20 00:00:00

Term2_TTM statistics for these rows:
Min: 84.0
Max: 98.0
Mean: 91.35

Sample of original contract specifications for these rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Index</th>
      <th>Term1_ContractSpec</th>
      <th>Term1_SettlementDate</th>
      <th>Term1_TTM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>52</th>
      <td>2010-03-19</td>
      <td>SPX</td>
      <td>MAR 10</td>
      <td>2010-03-19</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>115</th>
      <td>2010-06-18</td>
      <td>SPX</td>
      <td>JUN 10</td>
      <td>2010-06-18</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>178</th>
      <td>2010-09-17</td>
      <td>SPX</td>
      <td>SEP 10</td>
      <td>2010-09-17</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>242</th>
      <td>2010-12-17</td>
      <td>SPX</td>
      <td>DEC 10</td>
      <td>2010-12-17</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>304</th>
      <td>2011-03-18</td>
      <td>SPX</td>
      <td>MAR 11</td>
      <td>2011-03-18</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>367</th>
      <td>2011-06-17</td>
      <td>SPX</td>
      <td>JUN 11</td>
      <td>2011-06-17</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>430</th>
      <td>2011-09-16</td>
      <td>SPX</td>
      <td>SEP 11</td>
      <td>2011-09-16</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>494</th>
      <td>2011-12-16</td>
      <td>SPX</td>
      <td>DEC 11</td>
      <td>2011-12-16</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>555</th>
      <td>2012-03-16</td>
      <td>SPX</td>
      <td>MAR 12</td>
      <td>2012-03-16</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>619</th>
      <td>2012-06-15</td>
      <td>SPX</td>
      <td>JUN 12</td>
      <td>2012-06-15</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>After Analysis, we note that there are rows in the dataset for SPX index where the TTM was 0, corresponding to some of the rollover dates. We will resolve this in the code dowstream by adding these code blocks when merging:</p>
<p>dt = merged_df[ttm2] - merged_df[ttm1]
merged_df[fâ€cal_{index_code}_rfâ€] = np.where(
dt &gt; 0,
100.0 * merged_df[â€œimplied_forward_rawâ€] * (360.0 / dt),
np.nan
)</p>
<p>merged_df[fâ€ois_fwd_{index_code}â€] = np.where(
dt &gt; 0,
merged_df[â€œois_fwd_rawâ€] * (360.0 / dt) * 100.0,
np.nan
)</p>
</section>
<section id="futures-price-visualization">
<h2>Futures Price Visualization<a class="headerlink" href="#futures-price-visualization" title="Link to this heading">#</a></h2>
<p>Letâ€™s visualize the futures prices for Term1 and Term2 for each index:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up a multi-panel figure</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">indices</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
    <span class="n">index_df</span> <span class="o">=</span> <span class="n">combined_spreads</span><span class="p">[</span><span class="n">combined_spreads</span><span class="p">[</span><span class="s1">&#39;Index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">index</span><span class="p">]</span>
    
    <span class="c1"># Plot Term1 and Term2 prices</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">index_df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span> <span class="n">index_df</span><span class="p">[</span><span class="s1">&#39;Term1_Futures_Price&#39;</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Term1 (Nearby)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">index_df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span> <span class="n">index_df</span><span class="p">[</span><span class="s1">&#39;Term2_Futures_Price&#39;</span><span class="p">],</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Term2 (Deferred)&#39;</span><span class="p">)</span>
    
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1"> Futures Prices&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="c1"># Set common labels</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># Save the visualization</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_DIR</span> <span class="o">/</span> <span class="s1">&#39;futures_prices_by_index.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ff049d030e56d78a311b19fcb27e18ece3b6037f105b50df727507e5094a4418.png" src="../_images/ff049d030e56d78a311b19fcb27e18ece3b6037f105b50df727507e5094a4418.png" />
</div>
</div>
</section>
<section id="integration-with-forward-rate-calculations">
<h2>Integration with Forward Rate Calculations<a class="headerlink" href="#integration-with-forward-rate-calculations" title="Link to this heading">#</a></h2>
<p>The processed futures data is now ready for integration with the OIS rates data to calculate implied forward rates and arbitrage spreads.</p>
<p>The key outputs from this processing pipeline include:</p>
<ol class="arabic simple">
<li><p><strong>Individual Index Calendar Spreads</strong>: Saved as CSV files (<code class="docutils literal notranslate"><span class="pre">SPX_Calendar_spread.csv</span></code>, <code class="docutils literal notranslate"><span class="pre">NDX_Calendar_spread.csv</span></code>, <code class="docutils literal notranslate"><span class="pre">INDU_Calendar_spread.csv</span></code>) in the <code class="docutils literal notranslate"><span class="pre">PROCESSED_DIR</span></code>.</p></li>
<li><p><strong>Combined Calendar Spreads</strong>: Saved as <code class="docutils literal notranslate"><span class="pre">all_indices_calendar_spreads.csv</span></code> in the <code class="docutils literal notranslate"><span class="pre">PROCESSED_DIR</span></code>.</p></li>
</ol>
<p>These files contain the following critical information:</p>
<ul class="simple">
<li><p><strong>Term1_Futures_Price</strong> and <strong>Term2_Futures_Price</strong>: Prices for the nearby and deferred futures contracts</p></li>
<li><p><strong>Term1_SettlementDate</strong> and <strong>Term2_SettlementDate</strong>: Settlement dates for each contract</p></li>
<li><p><strong>Term1_TTM</strong> and <strong>Term2_TTM</strong>: Time-to-maturity in days</p></li>
</ul>
<p>In the next step, these files will be used along with the processed OIS rates to calculate:</p>
<ol class="arabic simple">
<li><p>Futures-implied forward rates</p></li>
<li><p>OIS-implied forward rates</p></li>
<li><p>Equity spot-futures arbitrage spreads</p></li>
</ol>
<p>The accurate processing of settlement dates and TTM is crucial for properly aligning the futures contracts with OIS rates and accumulating dividends over the correct time periods.</p>
</section>
</section>

<div class="section ablog__blog_comments">
   
</div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="01_OIS_Data_Processing.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">OIS Rate Data Processing Walkthrough</p>
      </div>
    </a>
    <a class="right-next"
       href="03_Spread_Calculations.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Equity Spot-Futures Arbitrage: Implied Forward Rate Computation</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#project-context-equity-spot-futures-arbitrage">Project Context: Equity Spot-Futures Arbitrage</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-libraries">Load Libraries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-utility-functions">Define Utility Functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-bloomberg-data">Load Bloomberg Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-index-futures-mapping">Define Index Futures Mapping</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#process-futures-data">Process Futures Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#process-all-indices">Process All Indices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analyze-contract-roll-patterns">Analyze Contract Roll Patterns</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-calendar-spreads">Create Calendar Spreads</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-and-analyze-calendar-spreads">Create and Analyze Calendar Spreads</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-quality-checks">Data Quality Checks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#futures-price-visualization">Futures Price Visualization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#integration-with-forward-rate-calculations">Integration with Forward Rate Calculations</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andy Andikko & Harrison Zhang
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2025, Andy Andikko &amp; Harrison Zhang.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>